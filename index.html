<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ParkApp v4.2 - Accesso Tecnici</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            overflow-x: hidden; 
            position: relative;
        }
        .container { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            width: 100%; 
            max-width: 420px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
            position: relative;
        }
        
        /* INDICATORE DB - Punto 6 */
        .db-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
        }
        .db-indicator:hover { transform: scale(1.2); }
        .db-indicator.green { background: #10b981; }
        .db-indicator.yellow { background: #f59e0b; }
        .db-indicator.red { background: #ef4444; }
        
        /* INFO DB (tooltip) */
        .db-info {
            position: absolute;
            top: 35px;
            right: 10px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 250px;
            font-size: 12px;
            z-index: 100;
            display: none;
            border: 1px solid #e2e8f0;
        }
        .db-info.show { display: block; }
        .db-info h4 { margin: 0 0 10px 0; color: #333; }
        .db-info p { margin: 5px 0; color: #666; }
        .db-info .success { color: #10b981; }
        .db-info .error { color: #ef4444; }
        
        .logo { text-align: center; font-size: 32px; font-weight: 800; color: #667eea; margin-bottom: 5px; }
        .version { text-align: center; color: #999; font-size: 12px; margin-bottom: 25px; }
        
        /* Toggle Form */
        .toggle { display: flex; gap: 10px; margin-bottom: 25px; background: #f5f5f5; padding: 5px; border-radius: 12px; }
        .toggle button { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .toggle button.active { background: white; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .form { display: none; }
        .form.active { display: block; }
        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; margin-bottom: 6px; color: #333; font-weight: 500; font-size: 14px; }
        .form-group input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; transition: border-color 0.3s; }
        .form-group input:focus { border-color: #667eea; }
        
        /* Auto-completamento - Punto 3 */
        .email-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-top: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 50;
            display: none;
        }
        .email-suggestions.show { display: block; }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: #f8fafc; }
        .suggestion-item .name { font-weight: 600; color: #333; font-size: 14px; }
        .suggestion-item .email { font-size: 12px; color: #94a3b8; }
        .suggestion-item .last-access { font-size: 11px; color: #10b981; margin-top: 4px; }

        .pin-field { letter-spacing: 10px; text-align: center; font-weight: bold; }

        button.btn-main { 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: opacity 0.3s;
        }
        button.btn-main:disabled { 
            opacity: 0.6; 
            cursor: not-allowed;
        }

        /* Messaggi */
        .messaggio { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0; 
            display: none; 
            font-size: 14px; 
            text-align: center; 
            line-height: 1.4;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .messaggio.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; display: block; }
        .messaggio.error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; display: block; }
        .messaggio.warning { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; display: block; }
        .messaggio.info { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; display: block; }

        /* Accesso Rapido */
        .saved-users { 
            margin-top: 25px; 
            border-top: 1px solid #eee; 
            padding-top: 20px; 
        }
        .saved-users-title { 
            font-size: 12px; 
            color: #aaa; 
            margin-bottom: 12px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }
        .user-item { 
            background: #fdfdfd; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.2s; 
        }
        .user-item:hover { 
            border-color: #667eea; 
            background: #f8f9ff; 
            transform: translateX(5px);
        }
        .user-item .info .name { font-weight: 700; color: #333; font-size: 15px; }
        .user-item .info .email { font-size: 12px; color: #888; }
        .user-item .info .last-access { 
            font-size: 10px; 
            color: #10b981; 
            margin-top: 5px; 
            display: flex; 
            align-items: center;
            gap: 4px;
        }
        .user-item .arrow { color: #667eea; font-size: 20px; }

        /* MODAL PINPAD */
        .pin-modal { 
            position: fixed; 
            bottom: -100%; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: flex-end; 
            transition: bottom 0.4s ease; 
            z-index: 1000; 
        }
        .pin-modal.open { bottom: 0; }
        .pin-content { 
            width: 100%; 
            background: white; 
            border-radius: 30px 30px 0 0; 
            padding: 30px 20px; 
            text-align: center; 
            box-shadow: 0 -10px 25px rgba(0,0,0,0.1); 
        }
        
        .pin-dots { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .dot { 
            width: 18px; 
            height: 18px; 
            border: 2px solid #ddd; 
            border-radius: 50%; 
            transition: all 0.2s; 
        }
        .dot.filled { 
            background: #667eea; 
            border-color: #667eea; 
            transform: scale(1.2); 
        }
        .dot.error { 
            border-color: #ef4444; 
            animation: shake 0.3s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .numpad { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            max-width: 300px; 
            margin: 0 auto; 
        }
        .num-btn { 
            background: #f8f9fa; 
            border: none; 
            border-radius: 50%; 
            width: 70px; 
            height: 70px; 
            font-size: 24px; 
            font-weight: 600; 
            color: #333; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0 auto;
        }
        .num-btn:active { 
            background: #e2e6ea; 
            transform: scale(0.95); 
        }
        .num-btn.action { 
            font-size: 16px; 
            color: #667eea; 
            background: transparent; 
        }
        
        /* Timer anti-bruteforce - Punto 4 */
        .timer-block {
            font-size: 12px;
            color: #ef4444;
            margin-top: 10px;
            display: none;
        }
        .timer-block.show { display: block; }

        /* DEBUG PANEL - Punto 7 (nascosto, si attiva con doppio tap) */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 11px;
            z-index: 2000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #333;
        }
        .debug-panel.show { display: block; }
        .debug-panel .header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            padding-bottom: 5px; 
            border-bottom: 1px solid #333; 
        }
        .debug-panel .close { 
            cursor: pointer; 
            color: #ef4444; 
            font-weight: bold; 
        }
        .debug-panel .log-entry { 
            margin: 3px 0; 
            color: #00ff00; 
            word-break: break-all; 
        }
        .debug-panel .log-error { color: #ff6b6b; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- INDICATORE DB INTERATTIVO - Punto 6 -->
        <div class="db-indicator" id="dbIndicator" onclick="toggleDbInfo()"></div>
        <div class="db-info" id="dbInfo">
            <h4>üìä Stato Connessione</h4>
            <p id="dbStatusText">Verifica in corso...</p>
            <p id="dbUrlText"></p>
            <p id="dbLatency"></p>
            <hr style="margin: 10px 0; border-color: #eee;">
            <p id="dbLastCheck"></p>
            <button onclick="testConnessione()" style="width:100%; margin-top:10px; padding:8px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer;">Test Connessione</button>
        </div>

        <div class="logo">ParkApp</div>
        <div class="version">Versione 4.0 - Accesso Applicazione</div>
        
        <div class="toggle">
            <button id="btnLoginToggle" class="active" onclick="mostraForm('login')">Accedi</button>
            <button id="btnRegToggle" onclick="mostraForm('registrazione')">Registrati</button>
        </div>
        
        <div id="formLogin" class="form active">
            <div class="form-group">
                <label>Email Aziendale</label>
                <input type="email" id="loginEmail" placeholder="mario.rossi@azienda.it" autocomplete="off" oninput="suggerisciEmail()" onfocus="suggerisciEmail()">
                <div id="emailSuggestions" class="email-suggestions"></div>
            </div>
            <button type="button" class="btn-main" id="btnApriPin" onclick="apriPinPad()">Inserisci PIN</button>
            
            <!-- Timer anti-bruteforce -->
            <div id="timerBlock" class="timer-block"></div>
            
            <div id="savedUsersContainer" class="saved-users">
                <div class="saved-users-title">Accesso Rapido</div>
                <div id="listaUtenti"></div>
            </div>
        </div>
        
        <div id="formRegistrazione" class="form">
            <div class="form-group">
                <label>Email Aziendale *</label>
                <input type="email" id="regEmail" placeholder="mario.rossi@azienda.it">
            </div>
            <div class="form-group">
                <label>Nome Completo *</label>
                <input type="text" id="regNome" placeholder="Mario Rossi">
            </div>
            <div class="form-group">
                <label>Telefono</label>
                <input type="tel" id="regTelefono" placeholder="3331234567">
            </div>
            <div class="form-group">
                <label>Scegli PIN (4 cifre) *</label>
                <input type="password" id="regPin" maxlength="4" class="pin-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric">
            </div>
            <p style="font-size: 11px; color: #888; margin-bottom: 10px;">* Dopo la registrazione, un amministratore dovr√† attivare il tuo profilo.</p>
            <button type="button" class="btn-main" id="btnReg" onclick="registrati()">Invia Richiesta</button>
        </div>
        
        <div id="messaggio" class="messaggio"></div>
    </div>

    <!-- MODAL PIN PAD -->
    <div id="pinModal" class="pin-modal">
        <div class="pin-content">
            <div style="margin-bottom: 10px; font-weight: 600; color: #666;">Inserisci il tuo PIN</div>
            <div class="pin-dots" id="pinDots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
            <div class="numpad">
                <button class="num-btn" onclick="pressNum(1)">1</button>
                <button class="num-btn" onclick="pressNum(2)">2</button>
                <button class="num-btn" onclick="pressNum(3)">3</button>
                <button class="num-btn" onclick="pressNum(4)">4</button>
                <button class="num-btn" onclick="pressNum(5)">5</button>
                <button class="num-btn" onclick="pressNum(6)">6</button>
                <button class="num-btn" onclick="pressNum(7)">7</button>
                <button class="num-btn" onclick="pressNum(8)">8</button>
                <button class="num-btn" onclick="pressNum(9)">9</button>
                <button class="num-btn action" onclick="chiudiPinPad()">CHIUDI</button>
                <button class="num-btn" onclick="pressNum(0)">0</button>
                <button class="num-btn action" onclick="cancellaNum()">CANC</button>
            </div>
        </div>
    </div>

    <!-- DEBUG PANEL (nascosto, doppio tap sul footer per attivare) - Punto 7 -->
    <div class="debug-panel" id="debugPanel">
        <div class="header">
            <span>üêû DEBUG CONSOLE</span>
            <span class="close" onclick="toggleDebugPanel()">‚úï</span>
        </div>
        <div id="debugLogs"></div>
    </div>

    <script>
    // ==============================================
    // CONFIGURAZIONE
    // ==============================================
    const CONFIG = {
        SUPABASE_URL: 'https://berlfufnmolyrmxeyqfd.supabase.co',
        SUPABASE_KEY: 'sb_publishable_a3USDfV7gbuauU2Kd6DuQQ_8PFVElpy',
        REDIRECT_URL: 'menu.html',  // Modificato per puntare a menu.html
        MAX_ATTEMPTS: 3,
        BLOCK_TIME: 30 // secondi
    };

    // Inizializza Supabase
    const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
    
    // Variabili globali
    let currentPin = "";
    let tentativiFalliti = 0;
    let blockTimer = null;
    let blockTimeRemaining = 0;
    let connectionStatus = { online: false, latency: null, lastCheck: null };
    let debugLogs = [];

    // ==============================================
    // DEBUG LOGGING (Punto 7)
    // ==============================================
    function addDebugLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        debugLogs.unshift({ text: logEntry, type });
        
        // Mantieni solo ultimi 20 log
        if (debugLogs.length > 20) debugLogs.pop();
        
        updateDebugPanel();
    }

    function updateDebugPanel() {
        const container = document.getElementById('debugLogs');
        container.innerHTML = debugLogs.map(log => 
            `<div class="log-entry ${log.type === 'error' ? 'log-error' : ''}">${log.text}</div>`
        ).join('');
    }

    // Doppio tap sul container per debug
    let lastTap = 0;
    document.querySelector('.container').addEventListener('touchend', function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0) {
            toggleDebugPanel();
        }
        lastTap = currentTime;
    });

    window.toggleDebugPanel = function() {
        const panel = document.getElementById('debugPanel');
        panel.classList.toggle('show');
        if (panel.classList.contains('show')) {
            addDebugLog('Debug panel attivato');
        }
    };

    // ==============================================
    // CONTROLLO CONNESSIONE (Punto 1)
    // ==============================================
    async function testConnessione() {
        const start = Date.now();
        addDebugLog('Test connessione in corso...');
        
        try {
            // Test ping semplice
            const { error } = await supabaseClient
                .from('tecnici')
                .select('count', { count: 'exact', head: true });
            
            const latency = Date.now() - start;
            connectionStatus = {
                online: !error,
                latency: latency,
                lastCheck: new Date().toLocaleString()
            };
            
            updateDbIndicator();
            addDebugLog(`Test connessione: ${error ? '‚ùå Fallito' : '‚úÖ OK'} (${latency}ms)`);
            
            if (error) addDebugLog(`Errore: ${error.message}`, 'error');
            
        } catch (err) {
            connectionStatus = { online: false, latency: null, lastCheck: new Date().toLocaleString() };
            updateDbIndicator();
            addDebugLog(`Test connessione: ‚ùå Errore - ${err.message}`, 'error');
        }
    }

    function updateDbIndicator() {
        const indicator = document.getElementById('dbIndicator');
        const statusText = document.getElementById('dbStatusText');
        const urlText = document.getElementById('dbUrlText');
        const latencyText = document.getElementById('dbLatency');
        const lastCheckText = document.getElementById('dbLastCheck');
        
        // Aggiorna pallino
        indicator.className = 'db-indicator';
        if (!connectionStatus.online) {
            indicator.classList.add('red');
            statusText.innerHTML = '<span class="error">‚óè NON CONNESSO</span>';
        } else {
            if (connectionStatus.latency < 300) {
                indicator.classList.add('green');
                statusText.innerHTML = '<span class="success">‚óè CONNESSO (veloce)</span>';
            } else {
                indicator.classList.add('yellow');
                statusText.innerHTML = '<span class="warning">‚óè CONNESSO (lento)</span>';
            }
        }
        
        urlText.textContent = `URL: ${CONFIG.SUPABASE_URL.substring(0, 30)}...`;
        latencyText.textContent = `Latenza: ${connectionStatus.latency ? connectionStatus.latency + 'ms' : 'N/A'}`;
        lastCheckText.textContent = `Ultimo check: ${connectionStatus.lastCheck || 'Mai'}`;
    }

    window.toggleDbInfo = function() {
        document.getElementById('dbInfo').classList.toggle('show');
        if (!connectionStatus.lastCheck) testConnessione();
    };

    // ==============================================
    // GESTIONE UI
    // ==============================================
    window.mostraForm = function(tipo) {
        document.querySelectorAll('.form').forEach(f => f.classList.remove('active'));
        document.querySelectorAll('.toggle button').forEach(b => b.classList.remove('active'));
        document.getElementById('form' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
        document.getElementById('btn' + (tipo === 'login' ? 'Login' : 'Reg') + 'Toggle').classList.add('active');
        document.getElementById('messaggio').style.display = 'none';
        addDebugLog(`Form cambiato: ${tipo}`);
    };

    function mostraMessaggio(testo, tipo) {
        const m = document.getElementById('messaggio');
        m.textContent = testo;
        m.className = `messaggio ${tipo}`;
        m.style.display = 'block';
        
        // Auto-hide dopo 5 secondi per messaggi non critici
        if (tipo !== 'error') {
            setTimeout(() => {
                m.style.display = 'none';
            }, 5000);
        }
        
        addDebugLog(`Messaggio: ${testo} (${tipo})`, tipo === 'error' ? 'error' : 'info');
    }

    // ==============================================
    // AUTO-COMPLETAMENTO EMAIL (Punto 3)
    // ==============================================
    window.suggerisciEmail = function() {
        const input = document.getElementById('loginEmail').value.toLowerCase();
        const suggestions = document.getElementById('emailSuggestions');
        const utenti = JSON.parse(localStorage.getItem('park_tecnici') || '[]');
        
        if (input.length > 0 && utenti.length > 0) {
            const filtrati = utenti.filter(u => 
                u.email.toLowerCase().includes(input) || 
                u.nome.toLowerCase().includes(input)
            );
            
            if (filtrati.length > 0) {
                suggestions.innerHTML = filtrati.map(u => `
                    <div class="suggestion-item" onclick="selezionaSuggerimento('${u.email}')">
                        <div class="name">${u.nome}</div>
                        <div class="email">${u.email}</div>
                        ${u.lastAccess ? `<div class="last-access">üïí Ultimo accesso: ${u.lastAccess}</div>` : ''}
                    </div>
                `).join('');
                suggestions.classList.add('show');
                return;
            }
        }
        suggestions.classList.remove('show');
    };

    window.selezionaSuggerimento = function(email) {
        document.getElementById('loginEmail').value = email;
        document.getElementById('emailSuggestions').classList.remove('show');
        apriPinPad();
    };

    // ==============================================
    // ANTI-BRUTEFORCE (Punto 4)
    // ==============================================
    function startBlockTimer() {
        blockTimeRemaining = CONFIG.BLOCK_TIME;
        const btn = document.getElementById('btnApriPin');
        const timerDiv = document.getElementById('timerBlock');
        
        btn.disabled = true;
        
        blockTimer = setInterval(() => {
            blockTimeRemaining--;
            if (blockTimeRemaining <= 0) {
                clearInterval(blockTimer);
                btn.disabled = false;
                timerDiv.classList.remove('show');
                tentativiFalliti = 0;
                addDebugLog('Blocco sicurezza terminato');
            } else {
                timerDiv.textContent = `‚è±Ô∏è Troppi tentativi. Riprova tra ${blockTimeRemaining} secondi`;
                timerDiv.classList.add('show');
            }
        }, 1000);
        
        addDebugLog(`Blocco sicurezza attivato per ${CONFIG.BLOCK_TIME} secondi`);
    }

    // ==============================================
    // PIN PAD (Punto 5 - feedback visivo)
    // ==============================================
    window.apriPinPad = function() {
        const email = document.getElementById('loginEmail').value.trim();
        if (!email) {
            mostraMessaggio("Inserisci prima l'email", "error");
            return;
        }
        
        // Controlla se bloccato
        if (document.getElementById('btnApriPin').disabled) {
            mostraMessaggio("Accesso temporaneamente bloccato", "warning");
            return;
        }
        
        currentPin = "";
        aggiornaDots();
        document.getElementById('pinModal').classList.add('open');
        addDebugLog(`PinPad aperto per email: ${email}`);
    };

    window.chiudiPinPad = function() {
        document.getElementById('pinModal').classList.remove('open');
        // Reset dots error
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('error'));
    };

    window.pressNum = function(n) {
        if (currentPin.length < 4) {
            currentPin += n;
            aggiornaDots();
            if (currentPin.length === 4) {
                setTimeout(accedi, 300);
            }
        }
    };

    window.cancellaNum = function() {
        currentPin = currentPin.slice(0, -1);
        aggiornaDots();
    };

    function aggiornaDots() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => {
            d.classList.toggle('filled', i < currentPin.length);
            d.classList.remove('error');
        });
    }

    function feedbackPinErrato() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach(d => {
            d.classList.add('error');
            setTimeout(() => d.classList.remove('error'), 500);
        });
        
        // Vibrazione se supportata (Punto 5)
        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate(200);
        }
    }

    // ==============================================
    // LOGIN LOGIC (Punto 2 - errori specifici)
    // ==============================================
    window.accedi = async function() {
        const email = document.getElementById('loginEmail').value.trim();
        chiudiPinPad();
        
        // Test connessione rapido
        if (!connectionStatus.online) {
            await testConnessione();
            if (!connectionStatus.online) {
                mostraMessaggio("Database non raggiungibile. Verifica connessione.", "error");
                return;
            }
        }
        
        try {
            addDebugLog(`Tentativo login per: ${email}`);
            
            const { data, error } = await supabaseClient
                .from('tecnici')
                .select('*')
                .eq('Mail', email)
                .maybeSingle();

            if (error) {
                addDebugLog(`Errore DB: ${error.message}`, 'error');
                throw error;
            }

            // Email non trovata (errore specifico)
            if (!data) {
                mostraMessaggio("‚ùå Email non registrata nel sistema", "error");
                feedbackPinErrato();
                return;
            }

            // PIN errato
            if (data.pin !== currentPin) {
                tentativiFalliti++;
                addDebugLog(`PIN errato per ${email} (tentativo ${tentativiFalliti}/${CONFIG.MAX_ATTEMPTS})`);
                
                if (tentativiFalliti >= CONFIG.MAX_ATTEMPTS) {
                    startBlockTimer();
                    mostraMessaggio(`Troppi tentativi falliti. Bloccato per ${CONFIG.BLOCK_TIME} secondi`, "warning");
                } else {
                    mostraMessaggio(`PIN errato (tentativo ${tentativiFalliti}/${CONFIG.MAX_ATTEMPTS})`, "error");
                }
                feedbackPinErrato();
                return;
            }

            // Account non attivo (errore specifico)
            if (data.attivo === false || data.attivo === null) {
                mostraMessaggio("‚è≥ Account in attesa di approvazione dall'amministratore", "warning");
                addDebugLog(`Accesso negato: account non attivo (${email})`);
                return;
            }

            // SUCCESSO - Reset tentativi
            tentativiFalliti = 0;
            
            // Salva in localStorage con le chiavi che menu.html si aspetta
            localStorage.setItem('tecnico_loggato', data.nome_completo);
            localStorage.setItem('tecnico_id', data.id);
            
            // Aggiorna accesso rapido con timestamp - Punto 8
            salvaUtenteLocale(data.Mail, data.nome_completo);
            
            // Salva anche sessione
            sessionStorage.setItem('parkapp_user', JSON.stringify(data));
            
            mostraMessaggio(`‚úÖ Bentornato ${data.nome_completo}! Reindirizzamento...`, "success");
            addDebugLog(`Login riuscito: ${data.nome_completo} (ID: ${data.id})`);
            
            setTimeout(() => window.location.href = CONFIG.REDIRECT_URL, 1000);

        } catch (err) {
            addDebugLog(`Errore login: ${err.message}`, 'error');
            mostraMessaggio("Errore di connessione al database", "error");
        }
    };

    // ==============================================
    // REGISTRAZIONE
    // ==============================================
    window.registrati = async function() {
        const email = document.getElementById('regEmail').value.trim();
        const nome = document.getElementById('regNome').value.trim();
        const pin = document.getElementById('regPin').value.trim();
        const tel = document.getElementById('regTelefono').value.trim();
        const btn = document.getElementById('btnReg');

        if (!email || !nome || pin.length < 4) {
            mostraMessaggio("Compila tutti i campi obbligatori", "error");
            return;
        }

        if (!email.includes('@')) {
            mostraMessaggio("Inserisci un indirizzo email valido", "error");
            return;
        }

        btn.disabled = true;
        addDebugLog(`Tentativo registrazione: ${email}`);
        
        try {
            const { error } = await supabaseClient
                .from('tecnici')
                .insert([{
                    Mail: email,
                    nome_completo: nome,
                    pin: pin,
                    Telefono: tel,
                    ruolo: 'tecnico',
                    attivo: false
                }]);

            if (error) {
                addDebugLog(`Errore registrazione: ${error.message}`, 'error');
                throw error;
            }

            mostraMessaggio("‚úÖ Richiesta inviata! Attendi approvazione admin.", "success");
            addDebugLog(`Registrazione completata: ${email}`);
            
            setTimeout(() => mostraForm('login'), 3000);
        } catch (err) {
            if (err.message.includes('duplicate')) {
                mostraMessaggio("Email gi√† registrata nel sistema", "error");
            } else {
                mostraMessaggio("Errore durante la registrazione", "error");
            }
            btn.disabled = false;
        }
    };

    // ==============================================
    // LOCAL STORAGE (Accesso Rapido) con ULTIMO ACCESSO - Punto 8
    // ==============================================
    function salvaUtenteLocale(email, nome) {
        let list = JSON.parse(localStorage.getItem('park_tecnici') || '[]');
        const now = new Date().toLocaleString();
        
        // Rimuovi se esiste gi√†
        list = list.filter(u => u.email !== email);
        
        // Aggiungi con timestamp
        list.unshift({ 
            email, 
            nome, 
            lastAccess: now 
        });
        
        // Mantieni solo ultimi 5
        localStorage.setItem('park_tecnici', JSON.stringify(list.slice(0, 5)));
        caricaUtentiLocali();
    }

    function caricaUtentiLocali() {
        const list = JSON.parse(localStorage.getItem('park_tecnici') || '[]');
        if (list.length > 0) {
            document.getElementById('savedUsersContainer').style.display = 'block';
            document.getElementById('listaUtenti').innerHTML = list.map(u => `
                <div class="user-item" onclick="selezionaRapido('${u.email}')">
                    <div class="info">
                        <div class="name">${u.nome}</div>
                        <div class="email">${u.email}</div>
                        ${u.lastAccess ? `<div class="last-access">üïí ${u.lastAccess}</div>` : ''}
                    </div>
                    <div class="arrow">‚Ä∫</div>
                </div>
            `).join('');
        } else {
            document.getElementById('savedUsersContainer').style.display = 'none';
        }
    }

    window.selezionaRapido = function(email) {
        document.getElementById('loginEmail').value = email;
        apriPinPad();
        addDebugLog(`Accesso rapido selezionato: ${email}`);
    };

    // ==============================================
    // INIZIALIZZAZIONE
    // ==============================================
    window.addEventListener('load', function() {
        caricaUtentiLocali();
        testConnessione();
        
        // Nascondi suggerimenti quando si clicca fuori
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.form-group')) {
                document.getElementById('emailSuggestions').classList.remove('show');
            }
        });
        
        addDebugLog('Pagina caricata - Inizializzazione completata');
    });
    </script>
</body>
</html>