<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Annotazioni</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background-color: #f8fafc; margin: 0;">

    <div class="app-container">
        <!-- HEADER FISSO -->
        <div class="app-header">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <button onclick="tornaIndietro()" style="background: none; border: none; cursor: pointer;">
                    <span class="material-symbols-rounded" style="color: #64748b;">arrow_back</span>
                </button>
                <div>
                    <h1 style="margin: 0; font-size: 1.2rem; font-weight: 800;">Annotazioni</h1>
                    <div id="codice-impianto-header" style="font-size: 0.9rem; color: #2563eb; font-weight: 700; margin-top: 4px;">
                        Caricamento...
                    </div>
                </div>
            </div>

            <!-- CARD RIEPILOGO IMPIANTO -->
            <div id="card-impianto" style="background: white; border-radius: 16px; padding: 16px; border: 1px solid #e2e8f0; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div id="codice-impianto" style="font-size: 1.3rem; font-weight: 800; color: #1e293b; margin-bottom: 5px;">
                            Caricamento...
                        </div>
                        <div id="indirizzo-impianto" style="font-size: 0.9rem; color: #64748b; margin-bottom: 8px;">
                            Caricamento...
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; color: #475569;">
                            <span class="material-symbols-rounded" style="font-size: 16px;">calendar_today</span>
                            <span style="font-size: 0.85rem; font-weight: 600;">Ultima manut.: <span id="ultima-manutenzione">---</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CORPO DELLA PAGINA -->
        <main id="main-content" style="padding: 15px; padding-bottom: 180px !important;">
            <!-- FILTRO TIPO -->
            <div class="filtri-container">
                <div style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                    Filtra per tipo
                </div>
                <div class="filtri-wrapper">
                    <button onclick="filtraAnnotazioni('tutti')" class="filtro-tipo-compatto attivo" data-tipo="tutti">
                        Tutti
                    </button>
                    <button onclick="filtraAnnotazioni('0')" class="filtro-tipo-compatto" data-tipo="0">
                        Manutenzione
                    </button>
                    <button onclick="filtraAnnotazioni('1')" class="filtro-tipo-compatto" data-tipo="1">
                        Appuntamento
                    </button>
                    <button onclick="filtraAnnotazioni('2')" class="filtro-tipo-compatto" data-tipo="2">
                        Note
                    </button>
                </div>
            </div>

            <!-- SEZIONE CRONOLOGIA -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">
                        Cronologia Annotazioni
                    </div>
                    <div id="contatore-annotazioni" style="font-size: 0.8rem; color: #475569; font-weight: 600;">
                        0 annotazioni
                    </div>
                </div>

                <!-- LISTA ANNOTAZIONI -->
                <div id="lista-annotazioni">
                    <div style="text-align: center; padding: 40px 20px; color: #64748b;">
                        <span class="material-symbols-rounded" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px;">note_add</span>
                        <div style="font-weight: 600;">Nessuna annotazione presente</div>
                        <div style="font-size: 0.85rem; margin-top: 5px;">Aggiungi la prima annotazione</div>
                    </div>
                </div>
            </div>

            <!-- PULSANTE NUOVA ANNOTAZIONE (FLOATING) -->
            <button onclick="mostraFormNuovaAnnotazione()" id="btn-nuova-annotazione" style="position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #2563eb; color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); z-index: 90;">
                <span class="material-symbols-rounded" style="font-size: 24px;">add</span>
            </button>
        </main>

        <!-- MODAL NUOVA ANNOTAZIONE -->
        <div id="modal-nuova-annotazione" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 24px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; margin: 20px; animation: slideUp 0.3s ease-out;">
                <!-- HEADER MODAL -->
                <div style="padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-weight: 800; color: #1e293b; font-size: 1.1rem;">Nuova Annotazione</div>
                    <button onclick="chiudiModal()" style="background: none; border: none; cursor: pointer; color: #64748b;">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>

                <!-- FORM -->
                <div style="padding: 20px;">
                    <!-- SELEZIONE TIPO MIGLIORATA -->
                    <div class="selettore-tipo-container">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 8px;">
                            Tipo annotazione *
                        </div>
                        
                        <button type="button" onclick="selezionaTipo('0')" class="btn-tipo-opzione" data-tipo="0">
                            <div class="icona-tipo" data-tipo="0">
                                <span class="material-symbols-rounded">build</span>
                            </div>
                            <div class="testo-tipo">
                                <div class="tipo-titolo">Manutenzione</div>
                                <div class="tipo-descrizione">Aggiorna data ultima manutenzione</div>
                            </div>
                            <div class="checkmark-selezione">
                                <span class="material-symbols-rounded">check_circle</span>
                            </div>
                        </button>
                        
                        <button type="button" onclick="selezionaTipo('1')" class="btn-tipo-opzione" data-tipo="1">
                            <div class="icona-tipo" data-tipo="1">
                                <span class="material-symbols-rounded">calendar_today</span>
                            </div>
                            <div class="testo-tipo">
                                <div class="tipo-titolo">Appuntamento</div>
                                <div class="tipo-descrizione">Pianifica visita futura</div>
                            </div>
                            <div class="checkmark-selezione">
                                <span class="material-symbols-rounded">check_circle</span>
                            </div>
                        </button>
                        
                        <button type="button" onclick="selezionaTipo('2')" class="btn-tipo-opzione" data-tipo="2">
                            <div class="icona-tipo" data-tipo="2">
                                <span class="material-symbols-rounded">note</span>
                            </div>
                            <div class="testo-tipo">
                                <div class="tipo-titolo">Nota</div>
                                <div class="tipo-descrizione">Annotazione informativa (note obbligatorie)</div>
                            </div>
                            <div class="checkmark-selezione">
                                <span class="material-symbols-rounded">check_circle</span>
                            </div>
                        </button>
                        
                        <input type="hidden" id="tipo-selezionato" value="">
                    </div>

                    <!-- DATA -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 8px;">Data *</label>
                        <input type="date" id="data-annotazione" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-family: 'Inter'; font-size: 0.9rem; outline: none; box-sizing: border-box;">
                    </div>

                    <!-- NOTE -->
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 8px;">Note</label>
                        <textarea id="note-annotazione" placeholder="Seleziona un tipo per visualizzare il placeholder..." rows="4" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-family: 'Inter'; font-size: 0.9rem; outline: none; box-sizing: border-box; resize: vertical;"></textarea>
                        <div id="validazione-note" style="font-size: 0.75rem; color: #64748b; margin-top: 5px; display: none;">
                            <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">info</span>
                            <span id="testo-validazione">Le note sono facoltative per questo tipo</span>
                        </div>
                    </div>

                    <!-- INFO IMPIANTO -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 25px;">
                        <div style="font-size: 0.8rem; color: #64748b; font-weight: 600; margin-bottom: 5px;">Impianto</div>
                        <div id="info-impianto-modal" style="font-weight: 700; color: #1e293b;">Caricamento...</div>
                    </div>

                    <!-- PULSANTI -->
                    <div style="display: flex; gap: 10px;">
                        <button onclick="chiudiModal()" style="flex: 1; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #475569; font-weight: 600; cursor: pointer; font-family: 'Inter';">
                            Annulla
                        </button>
                        <button onclick="salvaAnnotazione()" id="btn-salva-annotazione" style="flex: 1; padding: 14px; border: none; border-radius: 12px; background: #2563eb; color: white; font-weight: 700; cursor: pointer; font-family: 'Inter';">
                            Salva Annotazione
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CONFERMA CANCELLAZIONE -->
        <div id="modal-conferma-cancellazione" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 24px; width: 90%; max-width: 350px; margin: 20px; animation: slideUp 0.3s ease-out;">
                <div style="padding: 25px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span class="material-symbols-rounded" style="font-size: 48px; color: #ef4444; margin-bottom: 10px;">warning</span>
                        <div style="font-weight: 800; color: #1e293b; font-size: 1.1rem; margin-bottom: 10px;">Conferma cancellazione</div>
                        <div style="color: #64748b; font-size: 0.9rem;">Sei sicuro di voler cancellare questa annotazione? Questa azione non pu√≤ essere annullata.</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="chiudiModalCancellazione()" style="flex: 1; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; color: #475569; font-weight: 600; cursor: pointer; font-family: 'Inter';">
                            Annulla
                        </button>
                        <button onclick="confermaCancellazione()" style="flex: 1; padding: 14px; border: none; border-radius: 12px; background: #ef4444; color: white; font-weight: 700; cursor: pointer; font-family: 'Inter';">
                            Cancella
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="annotazioni.js"></script>
</body>
</html>