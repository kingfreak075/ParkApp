
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ParkApp - Admin Veicoli</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="db-config.js"></script>
    <script src="check-db-config.js"></script>
    <style>
        .app-container {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 5rem;
        }
        
        .app-header-admin {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .admin-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0 0 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .input-group {
            margin-bottom: 1.25rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
            outline: none;
        }
        
        .btn-action {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            margin-top: 1rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-secondary {
            background: var(--primary-light);
            color: var(--primary);
            border: 2px solid var(--border);
        }
        
        .lista-veicoli {
            margin-top: 1.5rem;
        }
        
        .veicolo-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .veicolo-info h4 {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0 0 0.25rem 0;
        }
        
        .veicolo-info p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }
        
        .message {
            display: none;
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .message-success {
            background: #f0fdf4;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .message-error {
            background: #fef2f2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .app-footer {
            background: var(--white);
            padding: 1rem;
            text-align: center;
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 450px;
            margin: 0 auto;
        }
        
        .footer-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-app">
    <div class="app-container">
        <header class="app-header-admin">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <button onclick="window.location.href='menu.html'" style="background: none; border: none; padding: 0.5rem; color: var(--primary);">
                    <span class="material-symbols-rounded" style="font-size: 1.5rem;">arrow_back</span>
                </button>
                <div style="flex-grow: 1;">
                    <h1 style="font-size: 1.25rem; font-weight: 800; color: var(--primary); margin: 0;">
                        Admin Veicoli
                    </h1>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">
                        Assegnazione veicoli aziendali
                    </p>
                </div>
            </div>
        </header>

        <main>
            <!-- SEZIONE INSERIMENTO VEICOLO -->
            <div class="admin-section">
                <h2 class="section-title">
                    <span class="material-symbols-rounded">add_circle</span>
                    Nuovo Veicolo
                </h2>
                
                <div class="input-group">
                    <label class="input-label">Targa *</label>
                    <input type="text" id="targa" class="input-field" placeholder="AB123CD" maxlength="7">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Modello</label>
                    <input type="text" id="modello" class="input-field" placeholder="Fiat Doblo, Ford Transit, ecc.">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Tecnico Assegnato *</label>
                    <input type="text" id="tecnico" class="input-field" placeholder="Nome Cognome">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Note (opzionali)</label>
                    <textarea id="note" class="input-field" rows="3" placeholder="Note sul veicolo..."></textarea>
                </div>
                
                <button onclick="inserisciVeicolo()" class="btn-action btn-primary">
                    <span class="material-symbols-rounded">save</span>
                    Salva Veicolo
                </button>
            </div>

            <!-- SEZIONE LISTA VEICOLI -->
            <div class="admin-section">
                <h2 class="section-title">
                    <span class="material-symbols-rounded">list</span>
                    Veicoli Registrati
                </h2>
                
                <div id="lista-veicoli" class="lista-veicoli">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Caricamento veicoli...
                    </div>
                </div>
                
                <button onclick="caricaVeicoli()" class="btn-action btn-secondary">
                    <span class="material-symbols-rounded">refresh</span>
                    Aggiorna Lista
                </button>
            </div>
        </main>
<!-- SEZIONE APPROVAZIONE KILOMETRI -->
<div class="admin-section">
    <h2 class="section-title">
        <span class="material-symbols-rounded">approval</span>
        Approvazione Kilometri
    </h2>
    
    <div class="input-group">
        <label class="input-label">Filtra per Veicolo</label>
        <select id="filtro-veicolo" class="input-field" onchange="caricaKilometriDaApprovare()">
            <option value="">Tutti i veicoli</option>
            <!-- Le opzioni verranno caricate dinamicamente -->
        </select>
    </div>
    
    <div id="lista-kilometri-approvazione" class="lista-veicoli">
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            Caricamento kilometri in attesa...
        </div>
    </div>
    
    <button onclick="caricaKilometriDaApprovare()" class="btn-action btn-secondary">
        <span class="material-symbols-rounded">refresh</span>
        Aggiorna Lista
    </button>
</div>
        <!-- MESSAGGI -->
        <div id="messaggio-admin" class="message"></div>

        <footer class="app-footer">
            <span class="footer-text">EDIT BY KINGFREAK Version 1.0</span>
        </footer>
    </div>

    <script>
        // FUNZIONI ADMIN VEICOLI
        async function caricaVeicoli() {
            try {
                const supabase = getSupabaseClient();
                if (!supabase) throw new Error('DB non configurato');
                
                const { data: veicoli, error } = await supabase
                    .from('veicoli')
                    .select('*')
                    .order('targa', { ascending: true });
                
                if (error) throw error;
                
                const container = document.getElementById('lista-veicoli');
                if (!container) return;
                
                if (!veicoli || veicoli.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span class="material-symbols-rounded">directions_car_off</span>
                            <p style="margin-top: 0.5rem;">Nessun veicolo registrato</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                veicoli.forEach(veicolo => {
                    html += `
                        <div class="veicolo-item">
                            <div class="veicolo-info">
                                <h4>${veicolo.targa}</h4>
                                <p>${veicolo.modello || 'Modello non specificato'}</p>
                                <p style="font-size: 0.8rem; color: ${veicolo.attivo ? '#22c55e' : '#ef4444'};">
                                    <strong>Tecnico:</strong> ${veicolo.tecnico_assegnato}
                                    • ${veicolo.attivo ? 'Attivo' : 'Non attivo'}
                                </p>
                            </div>
                            <button onclick="cambiaStatoVeicolo('${veicolo.id}', ${!veicolo.attivo})" 
                                    style="background: none; border: none; color: ${veicolo.attivo ? '#ef4444' : '#22c55e'}; cursor: pointer;">
                                <span class="material-symbols-rounded">
                                    ${veicolo.attivo ? 'toggle_off' : 'toggle_on'}
                                </span>
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Errore caricamento veicoli:', error);
                mostraMessaggioAdmin('Errore nel caricamento veicoli', 'error');
            }
        }
        
        async function inserisciVeicolo() {
            try {
                const targa = document.getElementById('targa').value.trim().toUpperCase();
                const modello = document.getElementById('modello').value.trim();
                const tecnico = document.getElementById('tecnico').value.trim();
                const note = document.getElementById('note').value.trim();
                
                // Validazioni
                if (!targa) {
                    mostraMessaggioAdmin('Inserisci la targa', 'error');
                    return;
                }
                
                if (!tecnico) {
                    mostraMessaggioAdmin('Inserisci il tecnico assegnato', 'error');
                    return;
                }
                
                // Formato targa italiano
                const targaRegex = /^[A-Z]{2}[0-9]{3}[A-Z]{2}$/;
                if (!targaRegex.test(targa)) {
                    if (!confirm(`La targa "${targa}" non segue il formato italiano standard (AA111AA). Vuoi procedere comunque?`)) {
                        return;
                    }
                }
                
                const supabase = getSupabaseClient();
                if (!supabase) throw new Error('DB non configurato');
                
                // Controlla se la targa esiste già
                const { data: esistente, error: checkError } = await supabase
                    .from('veicoli')
                    .select('id')
                    .eq('targa', targa)
                    .maybeSingle();
                
                if (checkError) throw checkError;
                
                if (esistente) {
                    mostraMessaggioAdmin(`La targa ${targa} è già registrata`, 'error');
                    return;
                }
                
                // Inserisci veicolo
                const { error } = await supabase
                    .from('veicoli')
                    .insert([{
                        targa: targa,
                        modello: modello || null,
                        tecnico_assegnato: tecnico,
                        data_assegnazione: new Date().toISOString().split('T')[0],
                        note: note || null,
                        attivo: true
                    }]);
                
                if (error) throw error;
                
                // Reset form e mostra successo
                document.getElementById('targa').value = '';
                document.getElementById('modello').value = '';
                document.getElementById('tecnico').value = '';
                document.getElementById('note').value = '';
                
                mostraMessaggioAdmin(`Veicolo ${targa} inserito con successo!`, 'success');
                
                // Ricarica lista
                await caricaVeicoli();
                
            } catch (error) {
                console.error('Errore inserimento veicolo:', error);
                mostraMessaggioAdmin(`Errore: ${error.message}`, 'error');
            }
        }
        
        async function cambiaStatoVeicolo(id, nuovoStato) {
            try {
                if (!confirm(`Sei sicuro di voler ${nuovoStato ? 'attivare' : 'disattivare'} questo veicolo?`)) {
                    return;
                }
                
                const supabase = getSupabaseClient();
                if (!supabase) throw new Error('DB non configurato');
                
                const { error } = await supabase
                    .from('veicoli')
                    .update({ attivo: nuovoStato })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostraMessaggioAdmin(`Veicolo ${nuovoStato ? 'attivato' : 'disattivato'}`, 'success');
                
                // Ricarica lista
                await caricaVeicoli();
                
            } catch (error) {
                console.error('Errore cambio stato veicolo:', error);
                mostraMessaggioAdmin(`Errore: ${error.message}`, 'error');
            }
        }
        
        function mostraMessaggioAdmin(testo, tipo = 'info') {
            const messaggioDiv = document.getElementById('messaggio-admin');
            if (!messaggioDiv) return;
            
            messaggioDiv.textContent = testo;
            messaggioDiv.className = 'message';
            
            if (tipo === 'success') {
                messaggioDiv.classList.add('message-success');
            } else if (tipo === 'error') {
                messaggioDiv.classList.add('message-error');
            }
            
            messaggioDiv.style.display = 'block';
            
            setTimeout(() => {
                messaggioDiv.style.display = 'none';
            }, 5000);
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            await caricaVeicoli();
            await caricaKilometriDaApprovare(); // Aggiungi questa linea
        });

async function caricaKilometriDaApprovare() {
    try {
        const supabase = getSupabaseClient();
        if (!supabase) throw new Error('DB non configurato');
        
        // Prima carica la lista dei veicoli per il filtro
        await caricaFiltroVeicoli();
        
        const filtroVeicoloId = document.getElementById('filtro-veicolo').value;
        
        let query = supabase
            .from('kilometri_mensili')
            .select(`
                *,
                veicoli!inner(targa, modello, tecnico_assegnato)
            `)
            .eq('confermato', false)
            .order('data_inserimento', { ascending: false });
        
        // Applica filtro se selezionato
        if (filtroVeicoloId) {
            query = query.eq('veicolo_id', filtroVeicoloId);
        }
        
        const { data: kilometri, error } = await query;
        
        if (error) throw error;
        
        const container = document.getElementById('lista-kilometri-approvazione');
        if (!container) return;
        
        if (!kilometri || kilometri.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    <span class="material-symbols-rounded">check_circle</span>
                    <p style="margin-top: 0.5rem;">Nessun inserimento in attesa di approvazione</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        kilometri.forEach(km => {
            const veicolo = km.veicoli;
            const meseAnno = `${getNomeMese(km.mese)} ${km.anno}`;
            
            // Calcola differenza con l'ultimo inserimento confermato
            const kmPrecedenti = 0; // Dovresti caricare gli ultimi km confermati
            
            html += `
                <div class="veicolo-item" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h4>${veicolo.targa} - ${veicolo.modello || 'N/D'}</h4>
                            <p style="color: var(--text-muted); font-size: 0.85rem;">
                                <strong>Tecnico:</strong> ${veicolo.tecnico_assegnato}<br>
                                <strong>Periodo:</strong> ${meseAnno}<br>
                                <strong>Inserito il:</strong> ${formattaData(km.data_inserimento)}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">
                                ${km.km_fine_mese.toLocaleString()} km
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                Tachimetro
                            </div>
                        </div>
                    </div>
                    
                    ${km.note ? `
                    <div style="background: #f8fafc; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem;">
                        <strong>Note:</strong> ${km.note}
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="approvaKilometri('${km.id}')" 
                                style="flex: 1; background: #22c55e; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 800; cursor: pointer;">
                            <span class="material-symbols-rounded" style="vertical-align: middle; font-size: 1rem;">check</span>
                            Approva
                        </button>
                        <button onclick="rifiutaKilometri('${km.id}')" 
                                style="flex: 1; background: #ef4444; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 800; cursor: pointer;">
                            <span class="material-symbols-rounded" style="vertical-align: middle; font-size: 1rem;">close</span>
                            Rifiuta
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Errore caricamento kilometri da approvare:', error);
        mostraMessaggioAdmin('Errore nel caricamento kilometri', 'error');
    }
}

async function caricaFiltroVeicoli() {
    try {
        const supabase = getSupabaseClient();
        if (!supabase) return;
        
        const { data: veicoli, error } = await supabase
            .from('veicoli')
            .select('id, targa, modello')
            .order('targa', { ascending: true });
        
        if (error) throw error;
        
        const select = document.getElementById('filtro-veicolo');
        if (!select) return;
        
        // Salva l'opzione selezionata
        const selectedValue = select.value;
        
        // Costruisci le opzioni (mantenendo "Tutti i veicoli" come prima opzione)
        let options = '<option value="">Tutti i veicoli</option>';
        
        if (veicoli && veicoli.length > 0) {
            veicoli.forEach(veicolo => {
                const testo = `${veicolo.targa} - ${veicolo.modello || 'N/D'}`;
                options += `<option value="${veicolo.id}">${testo}</option>`;
            });
        }
        
        select.innerHTML = options;
        
        // Ripristina la selezione precedente
        if (selectedValue) {
            select.value = selectedValue;
        }
        
    } catch (error) {
        console.error('Errore caricamento filtro veicoli:', error);
    }
}

async function approvaKilometri(id) {
    try {
        if (!confirm("Sei sicuro di voler approvare questo inserimento kilometri?")) {
            return;
        }
        
        const supabase = getSupabaseClient();
        if (!supabase) throw new Error('DB non configurato');
        
        const { error } = await supabase
            .from('kilometri_mensili')
            .update({ 
                confermato: true,
                data_conferma: new Date().toISOString().split('T')[0]
            })
            .eq('id', id);
        
        if (error) throw error;
        
        mostraMessaggioAdmin('Kilometri approvati con successo!', 'success');
        
        // Ricarica la lista
        await caricaKilometriDaApprovare();
        
    } catch (error) {
        console.error('Errore approvazione kilometri:', error);
        mostraMessaggioAdmin(`Errore: ${error.message}`, 'error');
    }
}

async function rifiutaKilometri(id) {
    try {
        const motivo = prompt("Motivo del rifiuto (opzionale):");
        
        const supabase = getSupabaseClient();
        if (!supabase) throw new Error('DB non configurato');
        
        const { error } = await supabase
            .from('kilometri_mensili')
            .update({ 
                confermato: false,
                note: motivo ? `RIFIUTATO: ${motivo}` : 'RIFIUTATO senza motivo'
            })
            .eq('id', id);
        
        if (error) throw error;
        
        mostraMessaggioAdmin('Kilometri rifiutati', 'success');
        
        // Ricarica la lista
        await caricaKilometriDaApprovare();
        
    } catch (error) {
        console.error('Errore rifiuto kilometri:', error);
        mostraMessaggioAdmin(`Errore: ${error.message}`, 'error');
    }
}

// Funzioni utility
function getNomeMese(numeroMese) {
    const mesi = [
        'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
    ];
    return mesi[numeroMese - 1] || 'Mese non valido';
}

function formattaData(dataString) {
    if (!dataString) return 'Data non valida';
    
    try {
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return 'Data non valida';
        
        return data.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (error) {
        return 'Data non valida';
    }
}

    </script>
</body>
</html>
