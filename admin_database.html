<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloX Admin - Gestione Database</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="style_admin.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>





</head>
<body>
    <div class="admin-container">
        <!-- SIDEBAR -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="material-symbols-rounded">database</span>
                    <h1>FloX Admin</h1>
                </div>
                <div class="app-version">v2.0</div>
            </div>
            
           <!-- Modifica sidebar esistente -->
<!-- Sezione DATABASE -->
<div class="nav-section">
    <h3>DATABASE</h3>
    <button class="nav-btn" data-tab="config">
        <span class="material-symbols-rounded">settings</span>
        Configurazione
    </button>
    <button class="nav-btn" data-tab="tables">
        <span class="material-symbols-rounded">table_chart</span>
        Tabelle
    </button>
</div>
    
<!-- NUOVA: Sezione GESTIONE MANUALE -->
<div class="nav-section">
    <h3>GESTIONE MANUALE</h3>
    <button class="nav-btn" data-tab="personnel">
        <span class="material-symbols-rounded">groups</span>
        Personale
    </button>
    <button class="nav-btn" data-tab="vehicles">
        <span class="material-symbols-rounded">directions_car</span>
        Veicoli
    </button>
<!-- NUOVO: Pulsante ReperibilitÃ  -->
    <button class="nav-btn" data-tab="reperibilita">
        <span class="material-symbols-rounded">schedule</span>
        ReperibilitÃ 
    </button>
<!-- Nella sezione GESTIONE MANUALE, dopo ReperibilitÃ  -->
<button class="nav-btn" data-tab="parco">
    <span class="material-symbols-rounded">elevator</span>
    Parco Impianti
</button>

<!-- Dopo Parco Impianti, aggiungi: -->
<button class="nav-btn" data-tab="fogli">
    <span class="material-symbols-rounded">assignment</span>
    Fogli Lavoro
</button>


</div>
    
 <!-- Sezione SINCRONIZZAZIONE -->
<div class="nav-section">
    <h3>SINCRONIZZAZIONE</h3>
    <button class="nav-btn" data-tab="analyze">
        <span class="material-symbols-rounded">analytics</span>
        Analisi
    </button>
    <button class="nav-btn" data-tab="sync">
        <span class="material-symbols-rounded">sync</span>
        CSV Sync
    </button>
</div>
    
    <!-- Sezione UTILITIES -->
<div class="nav-section">
    <h3>UTILITIES</h3>
    <button class="nav-btn" data-tab="backup">
        <span class="material-symbols-rounded">backup</span>
        Backup
    </button>
    <button class="nav-btn" data-tab="logs">
        <span class="material-symbols-rounded">list_alt</span>
        Logs
    </button>
<!-- Dopo Logs, aggiungi: -->
<button class="nav-btn" data-tab="annotazioni">
    <span class="material-symbols-rounded">note_alt</span>
    Annotazioni
</button>

</div>
</nav>
            
            <div class="sidebar-footer">
                <div class="db-status" id="db-status">
                    <div class="status-indicator offline"></div>
                    <span>Database: Non connesso</span>
                </div>
                <button class="logout-btn">
                    <span class="material-symbols-rounded">logout</span>
                    Logout
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="admin-main">
            <!-- HEADER -->
            <header class="admin-header">
                <div class="header-left">
                    <h2 id="page-title">Configurazione Database</h2>
                    <div class="breadcrumb" id="breadcrumb">
                        <span>Home</span>
                        <span class="material-symbols-rounded">chevron_right</span>
                        <span>Database</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <div class="user-info">
                        <span class="material-symbols-rounded">account_circle</span>
                        <div>
                            <div class="user-name">Administrator</div>
                            <div class="user-role">Admin</div>
                        </div>
                    </div>
                    <button class="notifications-btn">
                        <span class="material-symbols-rounded">notifications</span>
                        <span class="notification-count">3</span>
                    </button>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="content-area">
                <!-- TAB 1: CONFIGURAZIONE DATABASE -->
                <div id="tab-config" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">database</span>
                                Configurazione Database Supabase
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-icon" title="Test connessione" onclick="testConnection()">
                                    <span class="material-symbols-rounded">wifi</span>
                                </button>
                                <button class="btn btn-icon" title="Esporta configurazione" onclick="exportConfig()">
                                    <span class="material-symbols-rounded">download</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="config-grid">
                                <!-- Configurazione attuale -->
                                <div class="config-current">
                                    <h4>Configurazione Attuale</h4>
                                    <div class="config-info">
                                        <div class="info-item">
                                            <span class="label">Stato:</span>
                                            <span id="config-status" class="value status-offline">Non configurato</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="label">URL Supabase:</span>
                                            <span id="config-url" class="value">-</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="label">Ultimo test:</span>
                                            <span id="config-last-test" class="value">-</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="label">Tempo online:</span>
                                            <span id="config-uptime" class="value">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Metodi di configurazione -->
                                <div class="config-methods">
                                    <h4>Nuova Configurazione</h4>
                                    <div class="tabs-horizontal">
                                        <button class="tab-btn active" data-method="file">File DB.kf</button>
                                        <button class="tab-btn" data-method="manual">Inserimento Manuale</button>
                                    </div>
                                    
                                    <!-- Metodo File -->
                                    <div id="method-file" class="method-content active">
                                        <div class="file-upload-area" id="drop-zone">
                                            <input type="file" id="file-kf" accept=".kf,.txt,.json" hidden>
                                            <span class="material-symbols-rounded">cloud_upload</span>
                                            <p>Trascina il file DB.kf qui o <a href="#" onclick="document.getElementById('file-kf').click()">clicca per selezionare</a></p>
                                            <small>Formati supportati: .kf, .txt, .json</small>
                                        </div>
                                        <div id="file-info" class="file-info" style="display: none;">
                                            <div class="file-info-content">
                                                <span class="material-symbols-rounded">check_circle</span>
                                                <div>
                                                    <strong>File caricato:</strong>
                                                    <span id="file-name"></span>
                                                </div>
                                                <button class="btn-icon-small" onclick="removeFile()">
                                                    <span class="material-symbols-rounded">close</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Metodo Manuale -->
                                    <div id="method-manual" class="method-content">
                                        <div class="form-group">
                                            <label for="supabase-url">SUPABASE URL</label>
                                            <input type="text" id="supabase-url" placeholder="https://tuoprogetto.supabase.co">
                                            <small>Dashboard â†’ Settings â†’ API</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="supabase-key">ANON KEY</label>
                                            <div class="input-with-icon">
                                                <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                                                <button class="btn-icon-small" onclick="togglePassword()">
                                                    <span class="material-symbols-rounded" id="toggle-icon">visibility</span>
                                                </button>
                                            </div>
                                            <small>Chiave anonima (pubblica) del progetto</small>
                                        </div>
                                    </div>
                                    
                                    <div class="config-actions">
                                        <button class="btn btn-primary" onclick="saveConfig()">
                                            <span class="material-symbols-rounded">save</span>
                                            Salva Configurazione
                                        </button>
                                        <button class="btn btn-secondary" onclick="resetConfig()">
                                            <span class="material-symbols-rounded">delete</span>
                                            Resetta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: TABELLE -->
                <div id="tab-tables" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">table_chart</span>
                                Gestione Tabelle
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-icon" onclick="refreshTables()">
                                    <span class="material-symbols-rounded">refresh</span>
                                </button>
                                <button class="btn btn-primary" onclick="showCreateTableModal()">
                                    <span class="material-symbols-rounded">add</span>
                                    Nuova Tabella
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="tables-overview">
                                <!-- Statistiche -->
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">table</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="total-tables">0</div>
                                            <div class="stat-label">Tabelle</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">data_array</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="total-rows">0</div>
                                            <div class="stat-label">Record Totali</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">storage</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="total-size">0 KB</div>
                                            <div class="stat-label">Spazio Occupato</div>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">history</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="last-sync">-</div>
                                            <div class="stat-label">Ultima Sincronizzazione</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista Tabelle -->
                                <div class="tables-list">
                                    <div class="table-filters">
                                        <div class="search-box">
                                            <span class="material-symbols-rounded">search</span>
                                            <input type="text" placeholder="Cerca tabella..." id="table-search">
                                        </div>
                                        <select id="table-filter">
                                            <option value="all">Tutte le tabelle</option>
                                            <option value="system">Tabelle di sistema</option>
                                            <option value="user">Tabelle utente</option>
                                        </select>
                                    </div>
                                    
                                    <div class="tables-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Nome</th>
                                                    <th>Tipo</th>
                                                    <th>Record</th>
                                                    <th>Dimensione</th>
                                                    <th>Ultima Modifica</th>
                                                    <th>Azioni</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tables-body">
                                                <!-- Le tabelle verranno caricate qui -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: ANALISI TABELLA -->
                <div id="tab-analyze" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">analytics</span>
                                Analisi e Configurazione Tabella
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-icon" onclick="refreshAnalysis()">
                                    <span class="material-symbols-rounded">refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="analyze-grid">
                                <!-- Selezione Tabella -->
                                <div class="card-section">
                                    <h4>Selezione Tabella</h4>
                                    <div class="form-group">
                                        <label for="table-select">Tabella da analizzare</label>
                                        <select id="table-select" onchange="loadTableStructure()">
                                            <option value="">Seleziona una tabella...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Struttura Tabella -->
                                <div class="card-section">
                                    <h4>Struttura Tabella</h4>
                                    <div id="table-structure" class="structure-info">
                                        <div class="structure-loading">
                                            <span class="material-symbols-rounded">hourglass_top</span>
                                            <p>Seleziona una tabella per visualizzare la struttura</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Selezione Chiave Primaria -->
                                <div class="card-section">
                                    <h4>Selezione Chiave Primaria</h4>
                                    <div id="key-selection" class="key-selection">
                                        <p class="info-text">La chiave primaria identifica univocamente ogni record.</p>
                                        <div id="key-options">
                                            <!-- Le opzioni verranno generate qui -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Anteprima Dati -->
                                <div class="card-section full-width">
                                    <div class="section-header">
                                        <h4>Anteprima Dati</h4>
                                        <select id="preview-limit" onchange="loadPreview()">
                                            <option value="10">10 record</option>
                                            <option value="25" selected>25 record</option>
                                            <option value="50">50 record</option>
                                            <option value="100">100 record</option>
                                        </select>
                                    </div>
                                    <div id="data-preview" class="data-preview">
                                        <p>Seleziona una tabella per visualizzare l'anteprima</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 4: SINCRONIZZA CSV -->
                <div id="tab-sync" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">sync</span>
                                Sincronizzazione CSV
                            </h3>
                        </div>
                        
                        <div class="card-body">
            <!-- AGGIUNGI QUI L'INDICATORE -->
            <div id="analysis-status" class="status-indicator" style="display: none;">
                <span class="status-icon">ðŸ“Š</span>
                <span id="analysis-status-text">Analisi non eseguita</span>
            </div>
            
            <div class="sync-grid">
                                <!-- Caricamento CSV -->
                                <div class="card-section">
                                    <h4>Carica File CSV</h4>
                                    <div class="file-upload-area large" id="csv-drop-zone">
                                        <input type="file" id="file-csv" accept=".csv,.txt" hidden>
                                        <span class="material-symbols-rounded">upload_file</span>
                                        <p>Trascina il file CSV qui o <a href="#" onclick="document.getElementById('file-csv').click()">clicca per selezionare</a></p>
                                        <small>Formati supportati: .csv, .txt (max 10MB)</small>
                                    </div>
                                    
                                    <div id="csv-info" class="file-info" style="display: none;">
                                        <div class="file-info-content">
                                            <span class="material-symbols-rounded">check_circle</span>
                                            <div>
                                                <strong>File CSV:</strong>
                                                <span id="csv-file-name"></span>
                                                <small id="csv-file-stats"></small>
                                            </div>
                                            <div class="file-actions">
                                                <button class="btn btn-sm" onclick="previewCSV()">Anteprima</button>
                                                <button class="btn-icon-small" onclick="removeCSV()">
                                                    <span class="material-symbols-rounded">close</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Opzioni CSV -->
                                    <div id="csv-options" class="form-grid" style="display: none;">
                                        <div class="form-group">
                                            <label for="csv-delimiter">Delimitatore</label>
                                            <select id="csv-delimiter">
                                                <option value=",">Virgola (,)</option>
                                                <option value=";">Punto e virgola (;)</option>
                                                <option value="\t">Tab</option>
                                                <option value="|">Pipe (|)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="csv-header">Intestazione</label>
                                            <select id="csv-header">
                                                <option value="true" selected>Prima riga come intestazione</option>
                                                <option value="false">Nessuna intestazione</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informazioni Confronto -->
                                <div class="card-section">
                                    <h4>Informazioni Confronto</h4>
                                    <div class="comparison-info">
                                        <div class="info-box">
                                            <div class="info-header">
                                                <span class="material-symbols-rounded">database</span>
                                                <h5>Database</h5>
                                            </div>
                                            <div class="info-content">
                                                <div><strong>Tabella:</strong> <span id="sync-table">-</span></div>
                                                <div><strong>Chiave:</strong> <span id="sync-key">-</span></div>
                                                <div><strong>Record:</strong> <span id="sync-db-count">0</span></div>
                                            </div>
                                        </div>
                                        
                                        <div class="info-box">
                                            <div class="info-header">
                                                <span class="material-symbols-rounded">description</span>
                                                <h5>File CSV</h5>
                                            </div>
                                            <div class="info-content">
                                                <div><strong>File:</strong> <span id="sync-csv-file">-</span></div>
                                                <div><strong>Record:</strong> <span id="sync-csv-count">0</span></div>
                                                <div><strong>Colonne:</strong> <span id="sync-csv-cols">0</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Corrispondenze Colonne -->
                                    <div id="column-mapping" style="display: none;">
                                        <h5>Corrispondenze Colonne</h5>
                                        <div id="mapping-list" class="mapping-list">
                                            <!-- Le corrispondenze verranno generate qui -->
                                        </div>
                                    </div>
                                </div>
                                <!-- Indicatore stato analisi -->

                                <!-- Opzioni Sincronizzazione -->
                                <div class="card-section">
                                    <h4>Opzioni Sincronizzazione</h4>
                                    <div class="form-group">
                                        <label>ModalitÃ </label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="sync-mode" value="analyze" checked>
                                                <span class="radio-custom"></span>
                                                Solo Analisi
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="sync-mode" value="sync">
                                                <span class="radio-custom"></span>
                                                Sincronizza
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Azioni</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="action-insert" checked>
                                                <span class="checkbox-custom"></span>
                                                Inserire nuovi record
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="action-update" checked>
                                                <span class="checkbox-custom"></span>
                                                Aggiornare record esistenti
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="action-delete">
                                                <span class="checkbox-custom"></span>
                                                Eliminare record dal DB
                                                <span class="badge badge-warning">ATTENZIONE</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="batch-size">Batch Size</label>
                                        <select id="batch-size">
                                            <option value="10">10 record/batch</option>
                                            <option value="50" selected>50 record/batch</option>
                                            <option value="100">100 record/batch</option>
                                            <option value="200">200 record/batch</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Riepilogo e Avvio -->
                                <div class="card-section">
                                    <h4>Riepilogo</h4>
                                    <div class="summary-stats" id="summary-stats">
                                        <div class="stat-item">
                                            <div class="stat-label">Nuovi</div>
                                            <div class="stat-value" id="stat-new">0</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Da Aggiornare</div>
                                            <div class="stat-value" id="stat-update">0</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Uguali</div>
                                            <div class="stat-value" id="stat-same">0</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-label">Da Eliminare</div>
                                            <div class="stat-value" id="stat-delete">0</div>
                                        </div>
                                    </div>
                                    
                                    <div class="sync-actions">
                                        <button class="btn btn-primary" id="btn-analyze" onclick="analyzeComparison()" disabled>
                                            <span class="material-symbols-rounded">analytics</span>
                                            Analizza Confronto
                                        </button>
                                        <button class="btn btn-success" id="btn-sync" onclick="startSync()" disabled>
                                            <span class="material-symbols-rounded">sync</span>
                                            Avvia Sincronizzazione
                                        </button>
                                    </div>
                                    <!-- Aggiungi questo nel tab sync (probabilmente intorno alla riga 400-450) -->

                                    <div id="warning-sync" class="alert alert-warning" style="display: none;">
                                        <span class="material-symbols-rounded">warning</span>
                                        <div id="warning-text"></div>
                                    </div>

                                </div>
                            </div>





                        </div>
                    </div>
                    
                    <!-- Risultati Sincronizzazione -->
                    <div id="sync-results" class="card" style="display: none;">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">task_alt</span>
                                Risultati Sincronizzazione
                            </h3>
                            <button class="btn btn-secondary" onclick="exportResults()">
                                <span class="material-symbols-rounded">download</span>
                                Esporta
                            </button>
                        </div>
                        
                        <div class="card-body">
                            <div class="results-grid">
                                <div class="results-stats">
                                    <div class="stat-card success">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">add_circle</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="result-inserted">0</div>
                                            <div class="stat-label">Inseriti</div>
                                        </div>
                                    </div>
                                    <div class="stat-card warning">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">update</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="result-updated">0</div>
                                            <div class="stat-label">Aggiornati</div>
                                        </div>
                                    </div>
                                    <div class="stat-card danger">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">delete</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="result-deleted">0</div>
                                            <div class="stat-label">Eliminati</div>
                                        </div>
                                    </div>
                                    <div class="stat-card info">
                                        <div class="stat-icon">
                                            <span class="material-symbols-rounded">error</span>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value" id="result-errors">0</div>
                                            <div class="stat-label">Errori</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="results-log">
                                    <h5>Log Operazioni</h5>
                                    <div id="sync-log" class="log-container">
                                        <!-- I log verranno aggiunti qui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


<!-- NUOVO TAB: Gestione Personale -->

<div id="tab-personnel" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3><span class="material-symbols-rounded">groups</span> Gestione Personale</h3>
            <div class="tabs-horizontal" id="personnel-tabs">
                <button class="tab-btn active" data-personnel-table="tecnici">Tecnici</button>
                <button class="tab-btn" data-personnel-table="manutentori">Manutentori</button>
                <button class="tab-btn" data-personnel-table="supervisori">Supervisori</button>
                <button class="tab-btn" data-personnel-table="venditori">Venditori</button>
            </div>
        </div>
        <div class="card-body">
            <!-- Contenuto verrÃ  popolato dinamicamente -->
            <div id="personnel-content"></div>
        </div>
    </div>
</div>

<!-- NUOVO TAB: Gestione Veicoli (Integrato) -->
<div id="tab-vehicles" class="tab-content">
    <!-- Card Principale -->
    <div class="card">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">directions_car</span>
                Gestione Flotta
            </h3>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="showAddVehicleModal()">
                    <span class="material-symbols-rounded">add</span>
                    Aggiungi Veicolo
                </button>
                <button class="btn btn-icon" onclick="loadVehicles()" title="Aggiorna">
                    <span class="material-symbols-rounded">refresh</span>
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Tabs interni -->
            <div class="tabs-horizontal" id="vehicle-tabs">
                <button class="tab-btn active" data-vehicle-view="fleet" onclick="switchVehicleView('fleet')">
                    <span class="material-symbols-rounded">garage</span>
                    Parco Auto
                </button>
                <button class="tab-btn" data-vehicle-view="approvals" onclick="switchVehicleView('approvals')">
                    <span class="material-symbols-rounded">approval</span>
                    Approvazioni
                </button>
            </div>
            
            <!-- View: Parco Auto -->
            <div id="vehicle-view-fleet" class="vehicle-view active">
                <div class="table-filters" style="margin: 1.5rem 0 1rem 0;">
                    <div class="search-box">
                        <span class="material-symbols-rounded">search</span>
                        <input type="text" placeholder="Cerca per targa, modello o driver..." id="search-fleet" onkeyup="filterFleetTable()">
                    </div>
                    <select id="filter-fleet-status" onchange="filterFleetTable()">
                        <option value="all">Tutti i veicoli</option>
                        <option value="active">Solo attivi</option>
                        <option value="inactive">Solo non attivi</option>
                    </select>
                </div>
                
                <div class="tables-container">
                    <table class="data-table" id="fleet-table">
                        <thead>
                            <tr>
                                <th>Targa</th>
                                <th>Modello</th>
                                <th>Driver Assegnato</th>
                                <th>Data Assegnazione</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="fleet-table-body">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="loading-spinner-small">
                                        <span class="material-symbols-rounded">hourglass_top</span>
                                        Caricamento veicoli...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- View: Approvazioni Kilometri -->
            <div id="vehicle-view-approvals" class="vehicle-view">
                <div class="table-filters" style="margin: 1.5rem 0 1rem 0;">
                    <div class="search-box">
                        <span class="material-symbols-rounded">search</span>
                        <input type="text" placeholder="Cerca per veicolo o tecnico..." id="search-approvals" onkeyup="filterApprovalsTable()">
                    </div>
                    <select id="filter-approvals-vehicle" class="filter-select" onchange="filterApprovalsTable()">
                        <option value="all">Tutti i veicoli</option>
                        <!-- Options verranno popolate dinamicamente -->
                    </select>
                </div>
                
                <div class="tables-container">
                    <table class="data-table" id="approvals-table">
                        <thead>
                            <tr>
                                <th>Data Inserimento</th>
                                <th>Veicolo</th>
                                <th>Tecnico</th>
                                <th>Periodo</th>
                                <th>Km Tachimetro</th>
                                <th>Note</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="approvals-table-body">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading-spinner-small">
                                        <span class="material-symbols-rounded">hourglass_top</span>
                                        Caricamento approvazioni...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Card Statistiche (secondaria) -->
    <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">analytics</span>
                Statistiche Flotta
            </h3>
        </div>
        <div class="card-body">
            <div class="stats-grid" id="vehicle-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">directions_car</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stats-total-vehicles">0</div>
                        <div class="stat-label">Veicoli Totali</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stats-active-vehicles">0</div>
                        <div class="stat-label">Veicoli Attivi</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">pending_actions</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stats-pending-approvals">0</div>
                        <div class="stat-label">Approvazioni in attesa</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">speed</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stats-total-km">0</div>
                        <div class="stat-label">Km Totali (ultimo mese)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NUOVO TAB: Gestione ReperibilitÃ  (integrato da admin_reperibilita.html) -->
<div id="tab-reperibilita" class="tab-content">
    <!-- Card Principale - Zone e Gestione -->
    <div class="card">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">schedule</span>
                Gestione ReperibilitÃ 
            </h3>
            <div class="tabs-horizontal" id="reperibilita-tabs">
                <button class="tab-btn active" data-reperibilita-tab="zone">Zone</button>
                <button class="tab-btn" data-reperibilita-tab="csv">Carica CSV</button>
                <button class="tab-btn" data-reperibilita-tab="festivita">FestivitÃ </button>
                <button class="tab-btn" data-reperibilita-tab="turni">Turni</button>
                <button class="tab-btn" data-reperibilita-tab="approvazioni">Approvazioni</button>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Contenitore per i sottotab della reperibilitÃ  -->
            <div id="reperibilita-content">
                <!-- ZONE TAB -->
                <div id="reperibilita-zone" class="reperibilita-tab-content active">
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-main); font-weight: 800;">Nuova Zona</h4>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; align-items: end; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label>Nome Zona *</label>
                                <input type="text" id="nome-zona" class="form-control" placeholder="BO EST, BO CENTRO, ecc." maxlength="50">
                            </div>
                            <div class="form-group">
                                <label>Colore</label>
                                <input type="color" id="colore-zona" value="#3B82F6" style="width: 100%; height: 42px; border-radius: 8px; border: 2px solid var(--border); cursor: pointer;">
                            </div>
                            <div class="form-group">
                                <button onclick="salvaZona()" class="btn btn-primary" style="width: 100%;">
                                    <span class="material-symbols-rounded">save</span>
                                    Salva Zona
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Descrizione (opzionale)</label>
                            <textarea id="descrizione-zona" class="form-control" rows="2" placeholder="Descrizione della zona..."></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">Zone Esistenti</h4>
                            <button onclick="caricaZone()" class="btn btn-icon">
                                <span class="material-symbols-rounded">refresh</span>
                            </button>
                        </div>
                        
                        <div id="lista-zone" class="lista-elementi">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <span class="material-symbols-rounded">sync</span>
                                <p style="margin-top: 0.5rem;">Caricamento zone...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CSV TAB -->
                <div id="reperibilita-csv" class="reperibilita-tab-content">
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-main); font-weight: 800;">Caricamento Turni da CSV</h4>
                        
                        <div class="form-group">
                            <label>Template CSV</label>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; border: 1px solid var(--border);">
                                <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--primary);">Scarica template:</p>
                                <button onclick="scaricaTemplateCSV()" class="btn btn-secondary" style="width: auto;">
                                    <span class="material-symbols-rounded">download</span>
                                    Template_Reperibilita.csv
                                </button>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                                    Formato: <code>DataInizio;Zona;Tecnico</code><br>
                                    Esempio: <code>2025-01-03;BO EST;Mario Rossi</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>File CSV *</label>
                            <div id="csv-drop-area" class="file-upload-area" onclick="document.getElementById('file-csv').click()" style="cursor: pointer;">
                                <input type="file" id="file-csv" accept=".csv" style="display: none;">
                                <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--primary-light); margin-bottom: 1rem;">cloud_upload</span>
                                <p style="font-weight: 800; color: var(--primary); margin: 0 0 0.5rem 0;">Clicca per selezionare file CSV</p>
                                <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;">Trascina qui il file o clicca per selezionare</p>
                            </div>
                            
                            <div id="file-info" style="display: none; background: #f8fafc; border-radius: 12px; padding: 1rem; margin-top: 1rem; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-weight: 800; color: var(--text-main); margin: 0 0 0.25rem 0;" id="file-name"></p>
                                        <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;" id="file-size"></p>
                                    </div>
                                    <button onclick="rimuoviFile()" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                                        <span class="material-symbols-rounded">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Opzioni</label>
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="backup-csv" checked>
                                    <span style="font-size: 0.9rem; font-weight: 600;">Crea backup prima dell'import</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="sovrascrivi-csv" checked>
                                    <span style="font-size: 0.9rem; font-weight: 600;">Sovrascrivi turni esistenti</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="anteprima-csv" style="display: none;"></div>
                        
                        <button onclick="validaECaricaCSV()" class="btn btn-primary" id="btn-carica-csv" disabled style="margin-top: 1rem;">
                            <span class="material-symbols-rounded">upload</span>
                            Valida e Carica CSV
                        </button>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">Storico Caricamenti</h4>
                            <button onclick="caricaStoricoCSV()" class="btn btn-icon">
                                <span class="material-symbols-rounded">refresh</span>
                            </button>
                        </div>
                        
                        <div id="storico-caricamenti" class="lista-elementi">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <span class="material-symbols-rounded">history</span>
                                <p style="margin-top: 0.5rem;">Nessun caricamento effettuato</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- FESTIVITÃ€ TAB -->
                <div id="reperibilita-festivita" class="reperibilita-tab-content">
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-main); font-weight: 800;">Nuova FestivitÃ </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label>Data *</label>
                                <input type="date" id="data-festivita" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Nome FestivitÃ  *</label>
                                <input type="text" id="nome-festivita" class="form-control" placeholder="Es: Capodanno">
                            </div>
                            <div class="form-group">
                                <label>Tipo *</label>
                                <select id="tipo-festivita" class="form-control">
                                    <option value="nazionale">Nazionale</option>
                                    <option value="regionale">Regionale</option>
                                    <option value="locale">Locale (per zona)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="zona-festivita-container" style="display: none; margin-top: 1rem;">
                            <div class="form-group">
                                <label>Zona (per festivitÃ  locale)</label>
                                <select id="zona-festivita" class="form-control">
                                    <!-- Le zone verranno caricate dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1rem;">
                            <label>Note (opzionali)</label>
                            <textarea id="note-festivita" class="form-control" rows="2" placeholder="Note aggiuntive..."></textarea>
                        </div>
                        
                        <button onclick="salvaFestivita()" class="btn btn-primary" style="margin-top: 1rem;">
                            <span class="material-symbols-rounded">add_circle</span>
                            Aggiungi FestivitÃ 
                        </button>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">FestivitÃ  Esistenti</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="filtro-anno-festivita" class="form-control" style="width: 150px;" onchange="caricaFestivita()">
                                    <option value="2025">2025</option>
                                    <option value="2026" selected>2026</option>
                                    <option value="tutti">Tutti gli anni</option>
                                </select>
                                <button onclick="caricaFestivita()" class="btn btn-icon">
                                    <span class="material-symbols-rounded">refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="lista-festivita" class="lista-elementi">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <span class="material-symbols-rounded">sync</span>
                                <p style="margin-top: 0.5rem;">Caricamento festivitÃ ...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TURNI TAB -->
                <div id="reperibilita-turni" class="reperibilita-tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">Visualizzazione Turni</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="esportaTurniCSV()" class="btn btn-secondary">
                                <span class="material-symbols-rounded">download</span>
                                Esporta CSV
                            </button>
                            <button onclick="caricaTurni()" class="btn btn-icon">
                                <span class="material-symbols-rounded">refresh</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Filtra per zona</label>
                            <select id="filtro-zona-turni" class="form-control" onchange="caricaTurni()">
                                <option value="">Tutte le zone</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtra per mese</label>
                            <select id="filtro-mese-turni" class="form-control" onchange="caricaTurni()">
                                <option value="">Tutti i mesi</option>
                                <option value="1">Gennaio</option>
                                <option value="2">Febbraio</option>
                                <option value="3">Marzo</option>
                                <option value="4">Aprile</option>
                                <option value="5">Maggio</option>
                                <option value="6">Giugno</option>
                                <option value="7">Luglio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Settembre</option>
                                <option value="10">Ottobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">Dicembre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="calendario-turni">
                        <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                            <span class="material-symbols-rounded">calendar_month</span>
                            <p style="margin-top: 0.5rem;">Seleziona i filtri per visualizzare i turni</p>
                        </div>
                    </div>
                </div>
                
                <!-- APPROVAZIONI TAB -->
                <div id="reperibilita-approvazioni" class="reperibilita-tab-content">
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">Richieste da Approvare</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="filtro-stato-approvazioni" class="form-control" style="width: 200px;" onchange="caricaRichiestePending()">
                                    <option value="pending">In attesa</option>
                                    <option value="peer_approval">Da collega</option>
                                    <option value="admin_approval">Da admin</option>
                                    <option value="tutti">Tutte le pendenti</option>
                                </select>
                                <button onclick="caricaRichiestePending()" class="btn btn-icon">
                                    <span class="material-symbols-rounded">refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="lista-richieste-pending" class="lista-elementi">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <span class="material-symbols-rounded">sync</span>
                                <p style="margin-top: 0.5rem;">Caricamento richieste...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h4 style="margin: 0; color: var(--text-main); font-weight: 800;">Storico Approvazioni</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="filtro-anno-storico" class="form-control" style="width: 120px;" onchange="caricaStoricoApprovazioni()">
                                    <option value="tutti">Tutti</option>
                                    <option value="2025">2025</option>
                                    <option value="2026" selected>2026</option>
                                </select>
                                <select id="filtro-tipo-storico" class="form-control" style="width: 150px;" onchange="caricaStoricoApprovazioni()">
                                    <option value="tutti">Tutti i tipi</option>
                                    <option value="scambio">Scambi</option>
                                    <option value="sostituzione">Sostituzioni</option>
                                    <option value="cessione_parziale">Cessioni</option>
                                </select>
                                <select id="filtro-stato-storico" class="form-control" style="width: 150px;" onchange="caricaStoricoApprovazioni()">
                                    <option value="tutti">Tutti gli stati</option>
                                    <option value="approved">Approvate</option>
                                    <option value="rejected">Rifiutate</option>
                                </select>
                                <button onclick="caricaStoricoApprovazioni()" class="btn btn-icon">
                                    <span class="material-symbols-rounded">refresh</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="storico-approvazioni" class="lista-elementi">
                            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                <span class="material-symbols-rounded">history</span>
                                <p style="margin-top: 0.5rem;">Nessuna approvazione registrata</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- NUOVO TAB: Gestione Parco Impianti -->
<div id="tab-parco" class="tab-content">
    <script>
    (function() {
        // Verifica se siamo nel tab parco e carica i dati
        setTimeout(function() {
            if (document.getElementById('tab-parco').classList.contains('active')) {
                if (typeof caricaImpianti === 'function') {
                    caricaImpianti();
                } else {
                    console.warn('Attendo caricamento admin_parco.js...');
                    // Prova ancora dopo 1 secondo
                    setTimeout(function() {
                        if (typeof caricaImpianti === 'function') {
                            caricaImpianti();
                        }
                    }, 1000);
                }
            }
        }, 500);
    })();
</script>
    <!-- Card Principale -->
    <div class="card">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">elevator</span>
                Gestione Parco Impianti
            </h3>
            <div class="card-actions">
         
                  <!-- A: -->
<button class="btn btn-primary" id="btn-nuovo-impianto-unico" onclick="mostraModalAggiuntaParco()">
    <span class="material-symbols-rounded">elevator</span>
    Nuovo Impianto
</button>
              <button class="btn btn-icon" onclick="if(typeof caricaImpianti === 'function') caricaImpianti(); else console.error('caricaImpianti non definita')" title="Aggiorna">
    <span class="material-symbols-rounded">refresh</span>
</button>
            </div>
        </div>
        
        <div class="card-body">
            <!-- STATISTICHE -->
            <div style="margin-bottom: 2rem;">
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); text-align: center; margin-bottom: 1.5rem;">
                    <span id="totale-impianti">0</span> <span style="font-size: 1rem; color: var(--text-muted);">impianti totali</span>
                </div>
                
                <div style="font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Giri</div>
                <div id="barra-giri" style="display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 0.5rem;">
                    <!-- I box giri verranno generati qui -->
                    <div style="min-width: 100px; background: #f8fafc; border-radius: 12px; padding: 1rem; text-align: center; border: 1px solid var(--border);">
                        <div style="font-size: 1.25rem; font-weight: 800;">Giro 1</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">0</div>
                    </div>
                </div>
            </div>
            
            <!-- FILTRI -->
            <div style="display: grid; grid-template-columns: 1fr 200px 200px; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="search-box">
                    <span class="material-symbols-rounded">search</span>
                    <input type="text" id="search-parco" placeholder="Cerca impianto, cliente, indirizzo..." onkeyup="filtraImpianti()">
                </div>
                
                <select id="filtro-giro-parco" class="form-control" onchange="filtraImpianti()">
                    <option value="">Tutti i giri</option>
                </select>
                
                <select id="filtro-tecnico-parco" class="form-control" onchange="filtraImpianti()">
                    <option value="">Tutti i tecnici</option>
                </select>
            </div>
            
            <!-- TABELLA IMPIANTI -->
            <div class="tables-container">
                <table class="data-table" id="tabella-parco">
                    <thead>
                        <tr>
                            <th style="width: 30px;">
                                <input type="checkbox" id="select-all-parco" onchange="selezionaTuttiParco()">
                            </th>
                            <th>Impianto</th>
                            <th>Tipo</th>
                            <th>Zona</th>
                            <th>Giro</th>
                            <th>Tecnico</th>
                            <th>Cliente</th>
                            <th>Indirizzo</th>
                            <th>Ult.Sem</th>
                            <th>Ult.VP</th>
                            <th>Ult.Man</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tabella-parco-body">
                        <tr>
                            <td colspan="13" class="text-center">
                                <div class="loading-spinner-small">
                                    <span class="material-symbols-rounded">hourglass_top</span>
                                    Caricamento impianti...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- BOTTONI BULK OPERATIONS -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="esportaCSVParco()">
                    <span class="material-symbols-rounded">download</span>
                    Esporta CSV
                </button>
                <button class="btn btn-secondary" onclick="mostraImportParco()">
                    <span class="material-symbols-rounded">upload</span>
                    Importa CSV
                </button>
                <button class="btn btn-danger" onclick="eliminaSelezionatiParco()">
                    <span class="material-symbols-rounded">delete</span>
                    Elimina selezionati
                </button>
            </div>
        </div>
    </div>
    
    <!-- Card Import CSV (inizialmente nascosta) -->
    <div id="card-import-parco" class="card" style="margin-top: 1.5rem; display: none;">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">upload</span>
                Importa CSV - Analisi
            </h3>
            <button class="btn-icon-small" onclick="chiudiImportParco()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        
        <div class="card-body">
            <!-- Area upload -->
            <div id="import-parco-step1">
                <div class="file-upload-area" id="drop-zone-parco">
                    <input type="file" id="file-parco-csv" accept=".csv" hidden>
                    <span class="material-symbols-rounded">cloud_upload</span>
                    <p>Trascina il file CSV qui o <a href="#" onclick="document.getElementById('file-parco-csv').click()">clicca per selezionare</a></p>
                    <small>Formato: CSV con separatore ;</small>
                </div>
                <!-- Dopo il drop zone, prima del bottone Analizza -->
<div id="feedback-csv-parco" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px; background: #f8fafc; border-left: 4px solid #3B82F6;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div style="font-weight: 800; color: var(--primary);" id="csv-feedback-titolo">File caricato</div>
            <div style="font-size: 0.9rem; color: var(--text-main);" id="csv-feedback-nome"></div>
            <div style="font-size: 0.8rem; color: var(--text-muted);" id="csv-feedback-dettagli"></div>
        </div>
        <div id="csv-feedback-icona" style="color: #22c55e;">
            <span class="material-symbols-rounded">check_circle</span>
        </div>
    </div>
</div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-secondary" onclick="scaricaTemplateParco()">
                        <span class="material-symbols-rounded">download</span>
                        Scarica Template
                    </button>
                    <button class="btn btn-primary" onclick="analizzaCSVParco()" id="btn-analizza-parco" disabled>
                        <span class="material-symbols-rounded">analytics</span>
                        Analizza CSV
                    </button>
                </div>
            </div>
            
            <!-- Risultati analisi (inizialmente nascosti) -->
            <div id="import-parco-step2" style="display: none;">
                <div id="riepilogo-analisi-parco" style="margin-bottom: 1.5rem;"></div>
                <div id="dettaglio-analisi-parco" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="annullaImportParco()">
                        Annulla
                    </button>
                    <button class="btn btn-primary" onclick="eseguiImportParco()" id="btn-import-parco">
                        <span class="material-symbols-rounded">sync</span>
                        Importa Selezionati
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NUOVO TAB: Fogli Lavoro -->
<!-- NUOVO TAB: Fogli Lavoro - STILE FOGLIOLAVORO -->
<div id="tab-fogli" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">assignment</span>
                Monitor Presenze
            </h3>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="mostraModalNuovoFoglio()">
    <span class="material-symbols-rounded">add</span>
    Nuovo Intervento
</button>
                <button class="btn btn-icon" onclick="caricaFogli()" title="Aggiorna">
                    <span class="material-symbols-rounded">refresh</span>
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <!-- STATISTICHE MENSILI (in alto) -->
            <div class="stats-grid" style="margin-bottom: 2rem;" id="stats-fogli-mensili">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">work</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="sumOrd">0,00</div>
                        <div class="stat-label">Lavorate</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">beach_access</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="sumAss">0,00</div>
                        <div class="stat-label">Assenze</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">schedule</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="sumStra">0,00</div>
                        <div class="stat-label">Straord.</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">directions_car</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="sumVgg">0,00</div>
                        <div class="stat-label">Viaggio</div>
                    </div>
                </div>
            </div>

            <!-- RIGA CON TOTALE / PREVISTE -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;" id="decadeStatus"></div>
                <div class="bg-white px-4 py-2 rounded-full border shadow-sm">
                    <span id="totalRatio" class="text-sm font-black italic">-- / --</span>
                </div>
            </div>

            <!-- FILTRI: Tecnico + Mese + Anno + Cerca -->
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div class="form-group">
                    <label>ðŸ‘¤ Tecnico</label>
                    <select id="selectTecnico" class="form-control" onchange="renderVistaMensile()">
                        <option value="">-- Seleziona Tecnico --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ðŸ“… Mese</label>
                    <select id="selectMese" class="form-control" onchange="renderVistaMensile()">
                        <option value="1">Gennaio</option>
                        <option value="2">Febbraio</option>
                        <option value="3">Marzo</option>
                        <option value="4">Aprile</option>
                        <option value="5">Maggio</option>
                        <option value="6">Giugno</option>
                        <option value="7">Luglio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Settembre</option>
                        <option value="10">Ottobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Dicembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ðŸ“… Anno</label>
                    <select id="selectAnno" class="form-control" onchange="renderVistaMensile()">
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ðŸ” Cerca</label>
                    <input type="text" id="search-fogli" class="form-control" placeholder="Impianto o indirizzo..." onkeyup="filtraTabella()">
                </div>
            </div>

            <!-- TABELLA MENSILE -->
            <div class="tables-container" style="overflow-x: auto;">
                <table class="data-table" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <thead>
                        <tr class="bg-slate-50 text-slate-500 text-[10px] uppercase font-black border-b">
                            <th style="width: 110px; text-align: left;">Data</th>
                            <th style="width: 90px; text-align: center;">Giorno</th>
                            <th style="width: 65px; text-align: center;">Ord.</th>
                            <th style="width: 65px; text-align: center;">Stra.</th>
                            <th style="width: 65px; text-align: center;">Vgg.</th>
                            <th style="text-align: left;">Dettaglio Codici</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODALI REPERIBILITÃ€ (da posizionare fuori dal tab, prima della chiusura del main) -->

<!-- Modale Dettaglio Richiesta -->
<div class="modal" id="modale-dettaglio-richiesta">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Dettaglio Richiesta</h3>
            <button class="btn-icon-small" onclick="chiudiModaleDettaglioRichiesta()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div id="dettaglio-richiesta-content"></div>
        </div>
        <div class="modal-footer">
            <button onclick="rifiutaRichiestaSelezionata()" class="btn btn-danger" style="flex: 1;">
                <span class="material-symbols-rounded">close</span>
                Rifiuta
            </button>
            <button onclick="approvaRichiestaSelezionata()" class="btn btn-success" style="flex: 1;">
                <span class="material-symbols-rounded">check</span>
                Approva
            </button>
        </div>
    </div>
</div>

<!-- Modale Conflitti -->
<div class="modal" id="modale-conflitti">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>
                <span class="material-symbols-rounded" style="color: #f59e0b;">warning</span>
                Conflitto di Richieste
            </h3>
            <button class="btn-icon-small" onclick="chiudiModaleConflitti()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div style="background: #fffbeb; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
                <p style="margin: 0; color: #92400e; font-weight: 600;">
                    <span class="material-symbols-rounded" style="vertical-align: middle;">info</span>
                    PiÃ¹ richieste per lo stesso turno. Puoi approvarne solo una.
                </p>
            </div>
            <div id="contenuto-conflitti"></div>
        </div>
        <div class="modal-footer">
            <button onclick="chiudiModaleConflitti()" class="btn btn-secondary" style="flex: 1;">Chiudi</button>
        </div>
    </div>
</div>

<!-- Modale Modifica Turno -->
<div class="modal" id="modale-modifica-turno">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Modifica Turno</h3>
            <button class="btn-icon-small" onclick="chiudiModaleModificaTurno()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div id="modifica-turno-content" data-turno-id=""></div>
            <div id="modifica-errore-message" style="display: none; background: #fef2f2; color: #991b1b; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444; margin-top: 1rem;"></div>
        </div>
        <div class="modal-footer">
            <button onclick="chiudiModaleModificaTurno()" class="btn btn-secondary" style="flex: 1;">Annulla</button>
            <button onclick="salvaModificaTurno()" class="btn btn-primary" style="flex: 2;">
                <span class="material-symbols-rounded">save</span>
                Salva Modifiche
            </button>
        </div>
    </div>
</div>

<!-- Modale Dettaglio Decisione (Storico) -->
<div class="modal" id="modale-dettaglio-decisione">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>
                <span class="material-symbols-rounded" id="decisione-icona">info</span>
                Dettagli Decisione
            </h3>
            <button class="btn-icon-small" onclick="chiudiModaleDettaglioDecisione()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div id="dettaglio-decisione-content"></div>
        </div>
        <div class="modal-footer">
            <button onclick="mostraDettagliTurno()" class="btn btn-secondary" style="flex: 1;">
                <span class="material-symbols-rounded">calendar_month</span>
                Vedi Turno
            </button>
            <button onclick="chiudiModaleDettaglioDecisione()" class="btn btn-primary" style="flex: 1;">
                Chiudi
            </button>
        </div>
    </div>
</div>

<!-- Modale Dettaglio Turno Storico -->
<div class="modal" id="modale-dettaglio-turno-storico">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Dettagli Turno</h3>
            <button class="btn-icon-small" onclick="chiudiModaleDettaglioTurnoStorico()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div id="dettaglio-turno-storico-content"></div>
        </div>
        <div class="modal-footer">
            <button onclick="chiudiModaleDettaglioTurnoStorico()" class="btn btn-primary" style="width: 100%;">Chiudi</button>
        </div>
    </div>
</div>

<!-- MODALE NUOVO/MODIFICA FOGLIO LAVORO -->
<div class="modal" id="modal-foglio">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="modal-foglio-titolo">Nuovo Foglio Lavoro</h3>
            <button class="btn-icon-small" onclick="chiudiModalFoglio()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <form id="form-foglio" onsubmit="event.preventDefault(); salvaFoglio();">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Tecnico *</label>
                        <select id="foglio-tecnico" class="form-control" required>
                            <option value="">Seleziona tecnico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="foglio-data" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Codice *</label>
                        <select id="foglio-codice" class="form-control" required onchange="aggiornaTipoDaCodice()">
                            <option value="">Seleziona codice</option>
                            <optgroup label="Lavori">
                                <option value="21">21 - Manutenzione</option>
                                <option value="22">22 - Chiamata</option>
                                <option value="24">24 - Enti</option>
                                <option value="13">13 - Riparazione</option>
                                <option value="10">10 - Q2SA</option>
                            </optgroup>
                            <optgroup label="Montaggi">
                                <option value="001">001 - Montaggio</option>
                                <option value="007">007 - Montaggio</option>
                            </optgroup>
                            <optgroup label="Assenze">
                                <option value="072">072 - Assemblea</option>
                                <option value="073">073 - Sciopero</option>
                                <option value="075">075 - Ferie</option>
                                <option value="076">076 - FestivitÃ </option>
                                <option value="077">077 - Malattia</option>
                                <option value="078">078 - Infortunio</option>
                                <option value="079">079 - Donazione Sangue</option>
                                <option value="080">080 - Allattamento</option>
                                <option value="081">081 - Congedo Matrimoniale</option>
                                <option value="082">082 - Permesso Retribuito</option>
                                <option value="083">083 - Permesso NON Retribuito</option>
                                <option value="084">084 - Permesso Legge 104</option>
                                <option value="085">085 - Permesso Elettorale</option>
                                <option value="086">086 - Permesso Lutto</option>
                                <option value="087">087 - Permesso Sindacale</option>
                                <option value="088">088 - Permesso Studio</option>
                                <option value="089">089 - Permesso Volontariato</option>
                                <option value="090">090 - Spese Generali</option>
                                <option value="091">091 - Altro Retribuito</option>
                                <option value="092">092 - Addestramento</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
  <div class="form-group">
    <label>Impianto / Commessa</label>
    <input type="text" id="foglio-impianto" class="form-control" 
           placeholder="Codice impianto o commessa" 
           list="lista-impianti"
           onblur="cercaIndirizzoImpianto()">
    <datalist id="lista-impianti"></datalist>
</div>
    <div class="form-group">
        <label>Indirizzo</label>
        <input type="text" id="foglio-indirizzo" class="form-control" placeholder="Via, cittÃ ...">
    </div>
</div>

                <div style="margin-top: 1rem;">
                    <label class="label-field">Tipo Ore *</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="foglio-tipo-ore" value="ORDINARIA" checked onchange="toggleTipoOreFoglio()">
                            <span>Ordinaria</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="foglio-tipo-ore" value="STRAORDINARIO" onchange="toggleTipoOreFoglio()">
                            <span>Straordinario</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="foglio-tipo-ore" value="REPERIBILITA" onchange="toggleTipoOreFoglio()">
                            <span>ReperibilitÃ </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="foglio-tipo-ore" value="MONTAGGIO" onchange="toggleTipoOreFoglio()">
                            <span>Montaggio</span>
                        </label>
                    </div>
                </div>

                <!-- Box Ore Dirette (per ORDINARIA) -->
                <div id="foglio-box-ore-dirette" style="margin-top: 1rem;">
                    <div class="form-group">
                        <label>Ore Lavorate</label>
                        <input type="number" id="foglio-ore-ord" class="form-control" step="0.25" min="0" max="24" value="0">
                        <small>Formato: 1.5 = 1 ora e 30 minuti</small>
                    </div>
                </div>

                <!-- Box Orari (per STRAORDINARIO/REPERIBILITA) -->
                <div id="foglio-box-orari" style="display: none; margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Ora Inizio</label>
                            <input type="time" id="foglio-ora-inizio" class="form-control" onchange="calcolaOreFoglio()">
                        </div>
                        <div class="form-group">
                            <label>Ora Fine</label>
                            <input type="time" id="foglio-ora-fine" class="form-control" onchange="calcolaOreFoglio()">
                        </div>
                    </div>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-top: 0.5rem; display: flex; gap: 2rem;">
                        <div><strong>Ordinarie:</strong> <span id="foglio-calcolo-ord">0.00</span></div>
                        <div><strong>Straordinarie:</strong> <span id="foglio-calcolo-stra">0.00</span></div>
                    </div>
                </div>

                <!-- Ore Viaggio -->
                <div style="margin-top: 1rem;">
                    <div class="form-group">
                        <label>Ore Viaggio</label>
                        <input type="number" id="foglio-ore-viaggio" class="form-control" step="0.5" min="0" max="8" value="0">
                    </div>
                </div>

                <!-- Note -->
                <div style="margin-top: 1rem;">
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="foglio-note" class="form-control" rows="3" placeholder="Descrizione intervento..."></textarea>
                    </div>
                </div>

                <input type="hidden" id="foglio-id">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="chiudiModalFoglio()">Annulla</button>
            <button class="btn btn-primary" onclick="salvaFoglio()">Salva Foglio</button>
        </div>
    </div>
</div>

<!-- MODALE IMPORT FOGLI -->
<div class="modal" id="modal-import-fogli">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Importa Fogli Lavoro</h3>
            <button class="btn-icon-small" onclick="chiudiImportFogli()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="file-upload-area" id="drop-zone-fogli">
                <input type="file" id="file-fogli-csv" accept=".csv" hidden>
                <span class="material-symbols-rounded">cloud_upload</span>
                <p>Trascina il file CSV qui o <a href="#" onclick="document.getElementById('file-fogli-csv').click()">clicca per selezionare</a></p>
                <small>Formato: CSV con separatore ;</small>
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" onclick="scaricaTemplateFogli()">
                    <span class="material-symbols-rounded">download</span>
                    Scarica Template
                </button>
                <button class="btn btn-primary" onclick="analizzaCSVFogli()" id="btn-analizza-fogli" disabled>
                    <span class="material-symbols-rounded">analytics</span>
                    Analizza CSV
                </button>
            </div>

            <div id="anteprima-import-fogli" style="margin-top: 1.5rem; display: none;"></div>
        </div>
    </div>
</div>


<!-- MODALE AGGIUNTA/MODIFICA IMPIANTO -->
<div class="modal" id="modal-parco">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="modal-parco-titolo">Nuovo Impianto</h3>
            <button class="btn-icon-small" onclick="chiudiModalParco()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <form id="form-parco" onsubmit="event.preventDefault(); salvaImpianto();">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="form-group">
                        <label>Impianto *</label>
                        <input type="text" id="parco-impianto" class="form-control" required maxlength="255">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <input type="text" id="parco-tipo" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Zona</label>
                        <input type="text" id="parco-zona" class="form-control">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Giro</label>
                        <select id="parco-giro" class="form-control">
                            <option value="">Seleziona giro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tecnico</label>
                        <input type="text" id="parco-tecnico" class="form-control" list="tecnici-parco">
                        <datalist id="tecnici-parco"></datalist>
                    </div>
                    <div class="form-group">
                        <label>PeriodicitÃ  (giorni)</label>
                        <input type="number" id="parco-periodicit" class="form-control" min="1" step="1">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Venditore</label>
                        <input type="text" id="parco-venditore" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Manutenzione</label>
                        <input type="text" id="parco-manut" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Mese semestrale</label>
                        <select id="parco-mese-sem" class="form-control">
                            <option value="">Seleziona mese</option>
                            <option value="1">Gennaio</option>
                            <option value="2">Febbraio</option>
                            <option value="3">Marzo</option>
                            <option value="4">Aprile</option>
                            <option value="5">Maggio</option>
                            <option value="6">Giugno</option>
                            <option value="7">Luglio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Settembre</option>
                            <option value="10">Ottobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Dicembre</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Amministratore</label>
                        <input type="text" id="parco-amministratore" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Esattore</label>
                        <input type="text" id="parco-esattore" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="parco-cliente" class="form-control">
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Indirizzo</label>
                            <input type="text" id="parco-indirizzo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>LocalitÃ </label>
                            <input type="text" id="parco-localit" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Provincia</label>
                            <input type="text" id="parco-prov" class="form-control" maxlength="2">
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label>Ultima semestrale</label>
                        <input type="date" id="parco-ult-sem" class="form-control">
                        <small>Formato: gg/mm/aaaa</small>
                    </div>
                    <div class="form-group">
                        <label>Ultima verifica periodica</label>
                        <input type="date" id="parco-ult-vp" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Ultima manutenzione</label>
                        <input type="date" id="parco-ult-man" class="form-control">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label>Note</label>
                    <textarea id="parco-note" class="form-control" rows="3"></textarea>
                </div>
                
                <input type="hidden" id="parco-id">
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="chiudiModalParco()">Annulla</button>
            <button class="btn btn-primary" onclick="salvaImpianto()">Salva Impianto</button>
        </div>
    </div>
</div>


<!-- MODALE CONFERMA CANCELLAZIONE (per singola) -->
<div class="modal" id="modal-conferma-cancellazione-ann">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <span class="material-symbols-rounded" style="font-size: 48px; color: #ef4444; margin-bottom: 1rem;">warning</span>
            <h3 style="margin: 0 0 0.5rem 0;">Conferma cancellazione</h3>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Sei sicuro di voler cancellare questo intervento?</p>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="chiudiModalCancellazioneIntervento()">Annulla</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="confermaCancellazioneIntervento()">Cancella</button>
            </div>
        </div>
    </div>
</div>





                <!-- TAB 5: BACKUP -->
                <div id="tab-backup" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">backup</span>
                                Backup e Ripristino
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>FunzionalitÃ  in sviluppo...</p>
                        </div>
                    </div>
                </div>

                <!-- TAB 6: LOGS -->
                <div id="tab-logs" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>
                                <span class="material-symbols-rounded">list_alt</span>
                                Logs di Sistema
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>FunzionalitÃ  in sviluppo...</p>
                        </div>
                    </div>
                </div>

<!-- NUOVO TAB: Annotazioni -->
<div id="tab-annotazioni" class="tab-content">
    <!-- Card Principale -->
    <div class="card">
        <div class="card-header">
            <h3>
                <span class="material-symbols-rounded">note_alt</span>
                Gestione Annotazioni
            </h3>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="mostraModalNuovaAnnotazioneAdmin()">
                    <span class="material-symbols-rounded">add</span>
                    Nuova Annotazione
                </button>
                <button class="btn btn-icon" onclick="caricaAnnotazioniAdmin()" title="Aggiorna">
                    <span class="material-symbols-rounded">refresh</span>
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <!-- STATISTICHE -->
            <div class="stats-grid" style="margin-bottom: 2rem;" id="stats-annotazioni">
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">note_alt</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-totale">0</div>
                        <div class="stat-label">Totale Annotazioni</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">build</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-manutenzioni">0</div>
                        <div class="stat-label">Manutenzioni</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">calendar_today</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-appuntamenti">0</div>
                        <div class="stat-label">Appuntamenti</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <span class="material-symbols-rounded">info</span>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="stat-note">0</div>
                        <div class="stat-label">Note</div>
                    </div>
                </div>
            </div>
            
            <!-- FILTRI AVANZATI -->
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; align-items: end;">
                <div class="form-group">
                    <label>ðŸ” Cerca nelle note</label>
                    <input type="text" id="filtro-testo-annotazioni" class="form-control" placeholder="Parola chiave..." onkeyup="filtraAnnotazioniAdmin()">
                </div>
                
                <div class="form-group">
                    <label>ðŸ“‹ Tipo</label>
                    <select id="filtro-tipo-annotazioni" class="form-control" onchange="filtraAnnotazioniAdmin()">
                        <option value="tutti">Tutti</option>
                        <option value="0">Manutenzione</option>
                        <option value="1">Appuntamento</option>
                        <option value="2">Nota</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ðŸ“… Dal</label>
                    <input type="date" id="filtro-data-da" class="form-control" onchange="filtraAnnotazioniAdmin()">
                </div>
                
                <div class="form-group">
                    <label>ðŸ“… Al</label>
                    <input type="date" id="filtro-data-a" class="form-control" onchange="filtraAnnotazioniAdmin()">
                </div>
                
                <div class="form-group">
                    <label>ðŸ¢ Impianto</label>
                    <input type="text" id="filtro-impianto-annotazioni" class="form-control" placeholder="Codice impianto..." list="impianti-annotazioni-list" onkeyup="filtraAnnotazioniAdmin()">
                    <datalist id="impianti-annotazioni-list"></datalist>
                </div>
            </div>
            
            <!-- TABELLA ANNOTAZIONI -->
            <div class="tables-container">
                <table class="data-table" id="tabella-annotazioni">
                    <thead>
                        <tr>
                            <th style="width: 30px;">
                                <input type="checkbox" id="select-all-annotazioni" onchange="selezionaTutteAnnotazioni()">
                            </th>
                            <th>Data</th>
                            <th>Impianto</th>
                            <th>Tipo</th>
                            <th>Note</th>
                            <th>Tecnico</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tabella-annotazioni-body">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading-spinner-small">
                                    <span class="material-symbols-rounded">hourglass_top</span>
                                    Caricamento annotazioni...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- BOTTONI BULK OPERATIONS -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="esportaCSVAnnotazioni()">
                    <span class="material-symbols-rounded">download</span>
                    Esporta CSV
                </button>
                <button class="btn btn-danger" onclick="eliminaSelezionateAnnotazioni()">
                    <span class="material-symbols-rounded">delete</span>
                    Elimina selezionate
                </button>
            </div>
        </div>
    </div>
</div>








            </div>
        </main>
    </div>






    

    <!-- MODAL ANTEPRIMA CSV -->
    <div id="modal-preview" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Anteprima CSV</h3>
                <button class="btn-icon-small" onclick="closePreview()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="preview-content"></div>
            </div>
        </div>
    </div>

    <!-- MODAL CREAZIONE TABELLA -->
    <div id="modal-create-table" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Crea Nuova Tabella</h3>
                <button class="btn-icon-small" onclick="closeCreateTableModal()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p>FunzionalitÃ  in sviluppo...</p>
            </div>
        </div>
    </div>

    <!-- MODAL LOADING -->
    <div id="modal-loading" class="modal">
        <div class="modal-content small">
            <div class="modal-body">
                <div class="loading-spinner">
                    <span class="material-symbols-rounded">sync</span>
                </div>
                <h4 id="loading-title">Caricamento in corso...</h4>
                <p id="loading-message">Attendere prego</p>

<!-- AGGIUNGI QUESTI 3 ELEMENTI -->
            <h4 id="titolo-elaborazione" style="display: none;">Caricamento...</h4>
            <p id="dettaglio-elaborazione" style="display: none;">Attendere...</p>
            <div id="stato-elaborazione" style="display: none;"></div>
            <!-- FINE ELEMENTI AGGIUNTI -->


                <div class="progress-bar">
                    <div id="loading-progress"></div>
                </div>
                <div class="progress-text">
                    <span id="loading-percent">0%</span>
                    <span id="loading-detail"></span>
                </div>
            </div>
        </div>
    </div>
<!-- MODALE NUOVA/MODIFICA ANNOTAZIONE (ADMIN) -->
<div class="modal" id="modal-annotazione-admin">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modal-annotazione-titolo">Nuova Annotazione</h3>
            <button class="btn-icon-small" onclick="chiudiModalAnnotazioneAdmin()">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <div class="modal-body">
            <!-- SELEZIONE IMPIANTO -->
            <div class="form-group">
                <label>Impianto *</label>
                <input type="text" id="ann-impianto" class="form-control" placeholder="Codice impianto..." list="impianti-annotazioni-modal-list" required>
                <datalist id="impianti-annotazioni-modal-list"></datalist>
            </div>
            
            <!-- SELEZIONE TIPO (come nella versione mobile) -->
            <div class="selettore-tipo-container" style="margin-bottom: 1.5rem;">
                <div style="font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 8px;">
                    Tipo annotazione *
                </div>
                
                <button type="button" onclick="selezionaTipoAdmin('0')" class="btn-tipo-opzione" data-tipo-admin="0">
                    <div class="icona-tipo" data-tipo-admin="0">
                        <span class="material-symbols-rounded">build</span>
                    </div>
                    <div class="testo-tipo">
                        <div class="tipo-titolo">Manutenzione</div>
                        <div class="tipo-descrizione">Aggiorna data ultima manutenzione</div>
                    </div>
                    <div class="checkmark-selezione">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                </button>
                
                <button type="button" onclick="selezionaTipoAdmin('1')" class="btn-tipo-opzione" data-tipo-admin="1">
                    <div class="icona-tipo" data-tipo-admin="1">
                        <span class="material-symbols-rounded">calendar_today</span>
                    </div>
                    <div class="testo-tipo">
                        <div class="tipo-titolo">Appuntamento</div>
                        <div class="tipo-descrizione">Pianifica visita futura</div>
                    </div>
                    <div class="checkmark-selezione">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                </button>
                
                <button type="button" onclick="selezionaTipoAdmin('2')" class="btn-tipo-opzione" data-tipo-admin="2">
                    <div class="icona-tipo" data-tipo-admin="2">
                        <span class="material-symbols-rounded">note</span>
                    </div>
                    <div class="testo-tipo">
                        <div class="tipo-titolo">Nota</div>
                        <div class="tipo-descrizione">Annotazione informativa</div>
                    </div>
                    <div class="checkmark-selezione">
                        <span class="material-symbols-rounded">check_circle</span>
                    </div>
                </button>
                
                <input type="hidden" id="ann-tipo" value="">
            </div>
            
            <!-- DATA -->
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="ann-data" class="form-control" required>
            </div>
            
            <!-- NOTE -->
            <div class="form-group">
                <label id="ann-note-label">Note</label>
                <textarea id="ann-note" class="form-control" rows="4" placeholder="Seleziona un tipo..."></textarea>
                <div id="ann-validazione-note" style="font-size: 0.75rem; color: #64748b; margin-top: 5px; display: none;">
                    <span class="material-symbols-rounded" style="font-size: 14px; vertical-align: middle;">info</span>
                    <span id="ann-testo-validazione"></span>
                </div>
            </div>
            
            <!-- TECNICO -->
            <div class="form-group">
                <label>Tecnico</label>
                <input type="text" id="ann-tecnico" class="form-control" value="Admin" readonly>
                <small style="color: #64748b;">Il tecnico verrÃ  registrato come Admin</small>
            </div>
            
            <input type="hidden" id="ann-id">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="chiudiModalAnnotazioneAdmin()">Annulla</button>
            <button class="btn btn-primary" onclick="salvaAnnotazioneAdmin()" id="btn-salva-annotazione-admin">Salva Annotazione</button>
        </div>
    </div>
</div>

<!-- MODALE CONFERMA CANCELLAZIONE (per singola) -->
<div class="modal" id="modal-conferma-cancellazione-ann">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <span class="material-symbols-rounded" style="font-size: 48px; color: #ef4444; margin-bottom: 1rem;">warning</span>
            <h3 style="margin: 0 0 0.5rem 0;">Conferma cancellazione</h3>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Sei sicuro di voler cancellare questa annotazione?</p>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="chiudiModalCancellazioneAnn()">Annulla</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="confermaCancellazioneAnn()">Cancella</button>
            </div>
        </div>
    </div>
</div>


 </body>
<!-- Poi il bottone di debug -->
<div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
    <button onclick="testAdminState()" style="padding: 5px 10px; font-size: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px;">
        DEBUG
    </button>
</div>

<script>
function testAdminState() {
    console.log('=== DEBUG ADMIN ===');
    console.log('window.comparisonResults:', window.comparisonResults);
    console.log('comparisonResults (locale):', typeof comparisonResults !== 'undefined' ? comparisonResults : 'non definita');
    console.log('Sono uguali?', window.comparisonResults === comparisonResults);
    console.log('ModalitÃ  sync:', document.querySelector('input[name="sync-mode"]:checked')?.value);
    console.log('Tabella:', currentTable);
    console.log('Chiave:', currentKey);
    
    if (window.comparisonResults) {
        const newCount = window.comparisonResults.new?.length || 0;
        const updateCount = window.comparisonResults.update?.length || 0;
        const deleteCount = window.comparisonResults.delete?.length || 0;
        console.log(`Dati: ${newCount} nuovi, ${updateCount} aggiornamenti, ${deleteCount} eliminazioni`);
    }
}
</script>

<script>
// Gestione sottotab ReperibilitÃ 
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”„ Inizializzazione sottotab reperibilitÃ ...');
    
    // Gestione cambio tab principale (giÃ  esistente in admin_database.js)
    // Questa parte dovrebbe giÃ  funzionare con i data-tab
    
    // Gestione sottotab interni della reperibilitÃ 
    const reperibilitaTabs = document.querySelectorAll('[data-reperibilita-tab]');
    const reperibilitaContents = document.querySelectorAll('.reperibilita-tab-content');
    
    if (reperibilitaTabs.length > 0) {
        console.log(`âœ… Trovati ${reperibilitaTabs.length} sottotab reperibilitÃ `);
        
        reperibilitaTabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Rimuovi active da tutti i tab
                reperibilitaTabs.forEach(t => t.classList.remove('active'));
                // Active al tab cliccato
                this.classList.add('active');
                
                // Nascondi tutti i contenuti
                reperibilitaContents.forEach(content => {
                    content.classList.remove('active');
                });
                
                // Mostra il contenuto corretto
                const targetId = 'reperibilita-' + this.dataset.reperibilitaTab;
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.add('active');
                    
                    // Carica dati specifici in base al tab
                    switch(this.dataset.reperibilitaTab) {
                        case 'zone':
                            if (typeof caricaZone === 'function') caricaZone();
                            break;
                        case 'csv':
                            if (typeof caricaStoricoCSV === 'function') {
                                caricaStoricoCSV();
                                caricaZonePerSelect();
                            }
                            break;
                        case 'festivita':
                            if (typeof caricaFestivita === 'function') {
                                caricaFestivita();
                                caricaZonePerSelect();
                            }
                            break;
                        case 'turni':
                            if (typeof caricaTurni === 'function') {
                                caricaZonePerSelect();
                                caricaTurni();
                            }
                            break;
                        case 'approvazioni':
                            if (typeof caricaRichiestePending === 'function') {
                                caricaRichiestePending();
                            }
                            break;
                    }
                }
            });
        });
    }
    
    // Setup event listener per tipo festivitÃ 
    const tipoFestivita = document.getElementById('tipo-festivita');
    if (tipoFestivita) {
        tipoFestivita.addEventListener('change', function() {
            const mostraZona = this.value === 'locale';
            document.getElementById('zona-festivita-container').style.display = mostraZona ? 'block' : 'none';
            if (mostraZona && typeof caricaZonePerSelect === 'function') {
                caricaZonePerSelect();
            }
        });
    }
    
    // Setup CSV upload
    setupCSVUploadWrapper();
});

// Wrapper per setup CSV upload (richiama la funzione esistente se disponibile)
function setupCSVUploadWrapper() {
    const dropArea = document.getElementById('csv-drop-area');
    const fileInput = document.getElementById('file-csv');
    
    if (!dropArea || !fileInput) return;
    
    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelectWrapper);
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    dropArea.addEventListener('drop', handleDropWrapper, false);
}

function handleFileSelectWrapper(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Seleziona un file CSV');
        rimuoviFileWrapper();
        return;
    }
    
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = `Dimensione: ${(file.size / 1024).toFixed(1)} KB`;
    document.getElementById('btn-carica-csv').disabled = false;
}

function handleDropWrapper(e) {
    e.preventDefault();
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        document.getElementById('file-csv').files = files;
        handleFileSelectWrapper({ target: { files: files } });
    }
}

function rimuoviFileWrapper() {
    document.getElementById('file-csv').value = '';
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('btn-carica-csv').disabled = true;
    document.getElementById('anteprima-csv').style.display = 'none';
    document.getElementById('anteprima-csv').innerHTML = '';
}

// Esponi le funzioni necessarie
window.rimuoviFile = rimuoviFileWrapper;
</script>


<script src="db-config.js"></script>
<script src="admin_database.js"></script>
<script src="db-rules.js"></script>  
<script src="admin_veicoli_manager.js"></script>
<script src="admin_reperibilita.js"></script>

<script src="admin_parco.js"></script>
<script src="admin_annotazioni.js"></script>
<script src="admin_foglio.js"></script>  



</body>
</html>