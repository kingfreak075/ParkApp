
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ParkApp - Configurazione</title>
    <!-- Stili uniformi -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- File di configurazione DB -->
    <script src="db-config.js"></script>
    <script src="check-db-config.js"></script>
    <style>
        /* ================================
           STILI MOBILE-FIRST (450px max)
           ================================ */
        
        /* RESET STILI DESKTOP */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }
        
        /* CONTENITORE PRINCIPALE MOBILE */
        .app-container {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            padding-bottom: 5rem;
        }
        
        /* HEADER COMPATTO */
        .app-header-config {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* MENU LATERALE SCOMPARSO - SOSTITUITO DA TAB INLINE */
        .config-tabs {
            display: flex;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 1rem;
        }
        
        .config-tab {
            flex: 1;
            min-width: 120px;
            padding: 0.875rem 1rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
            text-align: center;
            transition: all 0.2s;
        }
        
        .config-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(to bottom, rgba(37, 99, 235, 0.05), transparent);
        }
        
        .config-tab:hover {
            color: var(--primary);
        }
        
        /* CONTENUTO PRINCIPALE */
        .config-content-mobile {
            padding: 1rem;
        }
        
        /* SEZIONI A SCHEDA */
        .config-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .section-header .material-symbols-rounded {
            font-size: 1.5rem;
            color: var(--primary);
            background: var(--primary-light);
            padding: 0.5rem;
            border-radius: 10px;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0;
        }
        
        /* STATO DATABASE */
        .db-status-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }
        
        .db-status-info h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            font-weight: 700;
        }
        
        .db-status-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
        }
        
        .db-status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .db-status-badge.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .db-status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .db-status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* INPUT FIELDS */
        .input-group {
            margin-bottom: 1.25rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            background: #f8fafc;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
            outline: none;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon .material-symbols-rounded {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            cursor: pointer;
        }
        
        /* DROP ZONE MOBILE */
        .drop-zone-mobile {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 2rem 1rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .drop-zone-mobile:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
        }
        
        .drop-zone-mobile .material-symbols-rounded {
            font-size: 2.5rem;
            color: var(--primary);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }
        
        .drop-zone-title {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }
        
        .drop-zone-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .file-format-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        /* FILE INFO */
        .file-info-mobile {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #dcfce7;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #22c55e;
            margin-bottom: 1rem;
            animation: slideDown 0.3s ease-out;
        }
        
        .file-info-content h4 {
            font-size: 0.9rem;
            font-weight: 800;
            color: #166534;
            margin-bottom: 0.25rem;
        }
        
        .file-info-content p {
            font-size: 0.85rem;
            color: #15803d;
            font-weight: 600;
        }
        
        /* SEPARATORE */
        .separator {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        .separator::before,
        .separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        
        .separator span {
            padding: 0 1rem;
        }
        
        /* BOTTONI AZIONE */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }
        
        .btn-action {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-action:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: var(--primary-light);
            color: var(--primary);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #fecaca;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            color: white;
        }
        
        .btn-full {
            width: 100%;
            grid-column: 1 / -1;
        }
        
        /* MESSAGGI */
        .message-mobile {
            display: none;
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        }
        
        .message-success {
            background: #f0fdf4;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .message-error {
            background: #fef2f2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .message-info {
            background: #eff6ff;
            color: #1e40af;
            border-left: 4px solid var(--primary);
        }
        
        /* LOCALSTORAGE INFO */
        .storage-section {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .storage-item {
            background: white;
            border-radius: 8px;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        
        .storage-key {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }
        
        .storage-value {
            font-size: 0.8rem;
            color: var(--text-muted);
            word-break: break-all;
        }
        
        /* ANIMAZIONI */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* SCROLLBAR PERSONALIZZATA */
        .config-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .config-tabs::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .config-tabs::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        
        /* FOOTER */
        .app-footer {
            background: var(--white);
            padding: 1rem;
            text-align: center;
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 450px;
            margin: 0 auto;
            z-index: 100;
        }
        
        .footer-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        /* LOADING SPINNER */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        /* RESPONSIVE */
        @media (max-width: 450px) {
            .app-container {
                padding: 0;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-app">
    <div class="app-container">
        <!-- HEADER COMPATTO -->
        <header class="app-header-config">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <!-- Pulsante Indietro -->
                <button onclick="window.location.href='menu.html'" style="
                    background: none;
                    border: none;
                    padding: 0.5rem;
                    border-radius: 10px;
                    color: var(--primary);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <span class="material-symbols-rounded" style="font-size: 1.5rem;">arrow_back</span>
                </button>
                
                <!-- Titolo -->
                <div style="flex-grow: 1;">
                    <h1 style="font-size: 1.25rem; font-weight: 800; color: var(--primary); margin: 0;">
                        Configurazione
                    </h1>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">
                        Gestisci database e impostazioni
                    </p>
                </div>
                
                <!-- Indicatore DB -->
                <div id="db-status-indicator" style="
                    width: 10px;
                    height: 10px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    background: #f59e0b;
                    cursor: help;
                "></div>
            </div>
        </header>

        <!-- TABS MOBILE -->
        <nav class="config-tabs">
            <button class="config-tab active" onclick="loadSection('profilo')">
                <span class="material-symbols-rounded" style="font-size: 1.2rem; vertical-align: middle;">person</span>
                Profilo
            </button>
            <button class="config-tab" onclick="loadSection('database')">
                <span class="material-symbols-rounded" style="font-size: 1.2rem; vertical-align: middle;">database</span>
                Database
            </button>
        </nav>

        <!-- CONTENUTO PRINCIPALE -->
        <main class="config-content-mobile" id="main-content">
            <!-- SEZIONE PROFILO (predefinita) -->
            <div id="profilo-section">
                <!-- Stato Database -->
                <div class="config-section">
                    <div class="section-header">
                        <span class="material-symbols-rounded">database</span>
                        <h2 class="section-title">Stato Database</h2>
                    </div>
                    
                    <div id="db-status-cards">
                        <!-- Popolato dinamicamente da JS -->
                    </div>
                </div>

                <!-- Info App -->
                <div class="config-section">
                    <div class="section-header">
                        <span class="material-symbols-rounded">info</span>
                        <h2 class="section-title">Info Applicazione</h2>
                    </div>
                    
                    <div id="app-info">
                        <!-- Popolato dinamicamente da JS -->
                    </div>
                </div>

                <!-- localStorage -->
                <div class="storage-section" id="localstorage-section">
                    <div class="section-header">
                        <span class="material-symbols-rounded">storage</span>
                        <h2 class="section-title" style="color: #92400e;">LocalStorage</h2>
                    </div>
                    
                    <div id="storage-items">
                        <!-- Popolato dinamicamente da JS -->
                    </div>
                </div>

                <!-- Reset -->
                <div class="config-section">
                    <div class="section-header">
                        <span class="material-symbols-rounded" style="color: #dc2626;">warning</span>
                        <h2 class="section-title" style="color: #dc2626;">Reset Dati</h2>
                    </div>
                    
                    <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
                        Attenzione: questa operazione cancellerà tutti i dati locali dell'applicazione, inclusa la configurazione del database.
                    </p>
                    
                    <button class="btn-action btn-danger btn-full" onclick="resetAppData()">
                        <span class="material-symbols-rounded">delete_forever</span>
                        Reset Completo Dati App
                    </button>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="app-footer">
            <span class="footer-text">EDIT BY KINGFREAK Version 1.0</span>
        </footer>
    </div>

    <!-- SCRIPT PRINCIPALE - MANTENIAMO TUTTE LE FUNZIONI ORIGINALI -->
    <script>
        // VARIABILI GLOBALI PER DB
        let supabaseClient = null;
        let fileCaricato = null;

        // Funzione per caricare diverse sezioni nel contenuto
        function loadSection(section) {
            const mainContent = document.getElementById('main-content');
            
            // Attiva tab
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Cambia contenuto in base alla sezione selezionata
            if (section === 'profilo') {
                mainContent.innerHTML = `
                    <!-- SEZIONE PROFILO (predefinita) -->
                    <div id="profilo-section">
                        <!-- Stato Database -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">database</span>
                                <h2 class="section-title">Stato Database</h2>
                            </div>
                            
                            <div id="db-status-cards">
                                <!-- Popolato dinamicamente da JS -->
                            </div>
                        </div>

                        <!-- Info App -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">info</span>
                                <h2 class="section-title">Info Applicazione</h2>
                            </div>
                            
                            <div id="app-info">
                                <!-- Popolato dinamicamente da JS -->
                            </div>
                        </div>

                        <!-- localStorage -->
                        <div class="storage-section" id="localstorage-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">storage</span>
                                <h2 class="section-title" style="color: #92400e;">LocalStorage</h2>
                            </div>
                            
                            <div id="storage-items">
                                <!-- Popolato dinamicamente da JS -->
                            </div>
                        </div>

                        <!-- Reset -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded" style="color: #dc2626;">warning</span>
                                <h2 class="section-title" style="color: #dc2626;">Reset Dati</h2>
                            </div>
                            
                            <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
                                Attenzione: questa operazione cancellerà tutti i dati locali dell'applicazione, inclusa la configurazione del database.
                            </p>
                            
                            <button class="btn-action btn-danger btn-full" onclick="resetAppData()">
                                <span class="material-symbols-rounded">delete_forever</span>
                                Reset Completo Dati App
                            </button>
                        </div>
                    </div>
                `;
                
                setTimeout(loadProfileInfoMobile, 100);
                
            } else if (section === 'database') {
                mainContent.innerHTML = `
                    <!-- SEZIONE DATABASE -->
                    <div id="database-section">
                        <!-- Configurazione attuale -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">settings</span>
                                <h2 class="section-title">Configurazione Attuale</h2>
                            </div>
                            
                            <div id="current-config">
                                <!-- Popolato dinamicamente da JS -->
                            </div>
                        </div>

                        <!-- Carica file -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">upload</span>
                                <h2 class="section-title">Carica File Config</h2>
                            </div>
                            
                            <div style="position: relative; width: 100%;">
                                <input type="file" id="file-kf" accept=".kf,.txt,.json" 
                                       style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;">
                                <div class="drop-zone-mobile" id="drop-zone-mobile">
                                    <span class="material-symbols-rounded">cloud_upload</span>
                                    <div class="drop-zone-title">Trascina il file DB.kf qui</div>
                                    <div class="drop-zone-subtitle">Oppure clicca per selezionare</div>
                                    <div class="file-format-badge">.kf .txt .json</div>
                                </div>
                            </div>
                            
                            <div id="file-info-mobile" class="file-info-mobile" style="display: none;">
                                <div class="file-info-content">
                                    <h4>File caricato</h4>
                                    <p id="file-name-mobile"></p>
                                </div>
                                <button onclick="rimuoviFile()" style="background: none; border: none; color: #dc2626; cursor: pointer;">
                                    <span class="material-symbols-rounded">close</span>
                                </button>
                            </div>
                        </div>

                        <!-- Separatore -->
                        <div class="separator">
                            <span>OPPURE</span>
                        </div>

                        <!-- Inserimento manuale -->
                        <div class="config-section">
                            <div class="section-header">
                                <span class="material-symbols-rounded">keyboard</span>
                                <h2 class="section-title">Inserimento Manuale</h2>
                            </div>
                            
                            <!-- URL -->
                            <div class="input-group">
                                <label class="input-label">SUPABASE URL</label>
                                <input type="text" id="supabase-url" placeholder="https://tuoprogetto.supabase.co" class="input-field">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Dashboard → Settings → API
                                </div>
                            </div>
                            
                            <!-- Key -->
                            <div class="input-group">
                                <label class="input-label">ANON KEY</label>
                                <div class="input-with-icon">
                                    <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="input-field">
                                    <span class="material-symbols-rounded" onclick="togglePassword()" id="toggle-key-icon">visibility</span>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Chiave anonima (pubblica) del progetto
                                </div>
                            </div>
                        </div>

                        <!-- Pulsanti azione -->
                        <div class="action-buttons">
                            <button id="btn-test" onclick="testConnessione()" class="btn-action btn-primary">
                                <span id="icon-test" class="material-symbols-rounded">wifi</span>
                                <span id="text-test">Test Connessione</span>
                            </button>
                            
                            <button id="btn-export" onclick="esportaConfigurazione()" class="btn-action btn-secondary">
                                <span class="material-symbols-rounded">download</span>
                                Export
                            </button>
                            
                            <button id="btn-reset" onclick="resetConfigurazione()" class="btn-action btn-danger">
                                <span class="material-symbols-rounded">delete</span>
                                Reset
                            </button>
                        </div>

                        <!-- Messaggio stato -->
                        <div id="messaggio-stato-mobile" class="message-mobile"></div>
                    </div>
                `;
                
                setTimeout(initDBSection, 10);
            }
        }

        // CARICA INFORMAZIONI PROFILO (versione mobile)
        function loadProfileInfoMobile() {
            try {
                // Informazioni Database
                const dbInfo = getDbConfigInfo();
                
                // Aggiorna indicatori DB
                const indicator = document.getElementById('db-status-indicator');
                if (dbInfo.configured) {
                    indicator.style.background = '#22c55e';
                    indicator.title = `DB configurato • ${dbInfo.urlShort || 'N/A'}`;
                } else {
                    indicator.style.background = '#f59e0b';
                    indicator.title = 'Database non configurato';
                }
                
                // Aggiorna cards stato DB
                const dbStatusCards = document.getElementById('db-status-cards');
                if (dbStatusCards) {
                    dbStatusCards.innerHTML = `
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Configurato</h3>
                                <div class="db-status-value">${dbInfo.configured ? 'Sì' : 'No'}</div>
                            </div>
                            <div class="db-status-badge ${dbInfo.configured ? 'success' : 'error'}">
                                ${dbInfo.configured ? 'CONFIGURATO' : 'NON CONFIG'}
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Ultima Configurazione</h3>
                                <div class="db-status-value">${dbInfo.timestamp || 'Mai configurato'}</div>
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>URL Database</h3>
                                <div class="db-status-value">${dbInfo.urlShort || 'Non configurato'}</div>
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Chiave Presente</h3>
                                <div class="db-status-value">${dbInfo.keyPresent ? 'Sì' : 'No'}</div>
                            </div>
                            <div class="db-status-badge ${dbInfo.keyPresent ? 'success' : 'warning'}">
                                ${dbInfo.keyPresent ? 'PRESENTE' : 'ASSENTE'}
                            </div>
                        </div>
                    `;
                }
                
                // Aggiorna info app
                const appInfo = document.getElementById('app-info');
                if (appInfo) {
                    appInfo.innerHTML = `
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Nome App</h3>
                                <div class="db-status-value">ParkApp</div>
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Versione</h3>
                                <div class="db-status-value">1.0</div>
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Tecnico Loggato</h3>
                                <div class="db-status-value">${localStorage.getItem('tecnico_loggato') || 'Nessuno'}</div>
                            </div>
                        </div>
                    `;
                }
                
                // Mostra tutte le chiavi localStorage
                const storageItemsDiv = document.getElementById('storage-items');
                if (storageItemsDiv) {
                    const items = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        let value = localStorage.getItem(key);
                        
                        // Formatta il valore
                        let displayValue = value;
                        if (key.includes('key') || key.includes('token') || key.includes('password')) {
                            displayValue = '••••••••••••••••';
                        } else if (value && value.length > 30) {
                            displayValue = value.substring(0, 30) + '...';
                        }
                        
                        items.push(`
                            <div class="storage-item">
                                <div class="storage-key">${key}</div>
                                <div class="storage-value">${displayValue}</div>
                                <div style="font-size: 0.7rem; color: #94a3b8; margin-top: 5px;">
                                    Lunghezza: ${value.length} caratteri
                                </div>
                            </div>
                        `);
                    }
                    
                    storageItemsDiv.innerHTML = items.length ? 
                        items.join('') : 
                        '<p style="color: #64748b; font-style: italic;">Nessun dato salvato nel localStorage</p>';
                }
                
            } catch (error) {
                console.error('Errore caricamento info:', error);
            }
        }

        // RESET TUTTI I DATI APP
        function resetAppData() {
            if (!confirm('⚠️ ATTENZIONE!\n\nStai per cancellare TUTTI i dati locali dell\'applicazione, inclusi:\n• Configurazione database\n• Credenziali\n• Dati utente\n• Impostazioni\n\nSei sicuro di voler procedere?')) {
                return;
            }
            
            try {
                // Cancella tutto il localStorage
                localStorage.clear();
                
                // Mostra messaggio
                alert('✅ Tutti i dati locali sono stati cancellati.\nL\'applicazione verrà ricaricata.');
                
                // Ricarica la pagina
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                alert('❌ Errore durante il reset: ' + error.message);
            }
        }

        // INIZIALIZZAZIONE SEZIONE DATABASE
        function initDBSection() {
            // Carica configurazione salvata e mostra info
            mostraInfoConfigurazione();
            
            // Setup drag & drop
            setupDragAndDrop();
            
            // Setup file input
            const fileInput = document.getElementById('file-kf');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        }

        // FUNZIONE: Mostra info configurazione corrente
        function mostraInfoConfigurazione() {
            if (hasDbConfig()) {
                const info = getDbConfigInfo();
                const currentConfig = document.getElementById('current-config');
                
                if (currentConfig) {
                    currentConfig.innerHTML = `
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>URL Database</h3>
                                <div class="db-status-value">${info.urlShort || '-'}</div>
                            </div>
                            <div class="db-status-badge success">
                                CONFIGURATO
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Ultimo Test</h3>
                                <div class="db-status-value">${info.timestamp || '-'}</div>
                            </div>
                        </div>
                    `;
                }
                
                // Popola campi manuali
                const urlInput = document.getElementById('supabase-url');
                const keyInput = document.getElementById('supabase-key');
                
                if (urlInput) urlInput.value = info.url || '';
                if (keyInput) keyInput.value = '••••••••••••••••';
            } else {
                const currentConfig = document.getElementById('current-config');
                if (currentConfig) {
                    currentConfig.innerHTML = `
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Stato Database</h3>
                                <div class="db-status-value">Non configurato</div>
                            </div>
                            <div class="db-status-badge error">
                                NON CONFIG
                            </div>
                        </div>
                        
                        <div class="db-status-card">
                            <div class="db-status-info">
                                <h3>Configura ora il database</h3>
                                <div class="db-status-value">Carica un file o inserisci manualmente</div>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // FUNZIONE: Setup drag & drop
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone-mobile');
            if (!dropZone) return;
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--primary)';
                dropZone.style.backgroundColor = 'rgba(37, 99, 235, 0.02)';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.backgroundColor = '#f8fafc';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.backgroundColor = '#f8fafc';
                
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }

        // FUNZIONE: Gestione selezione file
        function handleFileSelect(event) {
            if (event.target.files.length) {
                handleFile(event.target.files[0]);
            }
        }

        // FUNZIONE: Processa file
        function handleFile(file) {
            if (!file.name.match(/\.(kf|txt|json)$/i)) {
                mostraMessaggio('Formato file non supportato. Usa .kf, .txt o .json', 'error');
                return;
            }
            
            if (file.size > 1024 * 10) {
                mostraMessaggio('File troppo grande (max 10KB)', 'error');
                return;
            }
            
            fileCaricato = file;
            
            const fileInfo = document.getElementById('file-info-mobile');
            const fileName = document.getElementById('file-name-mobile');
            
            if (fileInfo) fileInfo.style.display = 'flex';
            if (fileName) fileName.textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const success = importDbConfig(e.target.result);
                    if (success) {
                        mostraMessaggio(`✅ Configurazione caricata da ${file.name}`, 'success');
                        // Popola campi manuali
                        const info = getDbConfigInfo();
                        const urlInput = document.getElementById('supabase-url');
                        const keyInput = document.getElementById('supabase-key');
                        
                        if (urlInput) urlInput.value = info.url || '';
                        if (keyInput) keyInput.value = '••••••••••••••••';
                        
                        // Aggiorna info
                        mostraInfoConfigurazione();
                    }
                } catch (error) {
                    mostraMessaggio(`Errore: ${error.message}`, 'error');
                    rimuoviFile();
                }
            };
            reader.readAsText(file);
        }

        // FUNZIONE: Rimuovi file caricato
        function rimuoviFile() {
            fileCaricato = null;
            const fileInfo = document.getElementById('file-info-mobile');
            if (fileInfo) fileInfo.style.display = 'none';
            
            const fileInput = document.getElementById('file-kf');
            if (fileInput) fileInput.value = '';
        }

        // FUNZIONE: Mostra/nascondi password
        function togglePassword() {
            const input = document.getElementById('supabase-key');
            const toggleIcon = document.getElementById('toggle-key-icon');
            
            if (!input || !toggleIcon) return;
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleIcon.textContent = 'visibility_off';
                
                // Se il campo mostra placeholder, reimposta a vuoto quando si mostra
                if (input.value === '••••••••••••••••') {
                    const actualKey = getSupabaseKey();
                    if (actualKey) {
                        input.value = actualKey;
                    }
                }
            } else {
                input.type = 'password';
                toggleIcon.textContent = 'visibility';
                
                // Nascondi la chiave reale
                if (input.value !== '••••••••••••••••') {
                    input.value = '••••••••••••••••';
                }
            }
        }

        // FUNZIONE: Test connessione Supabase
        async function testConnessione() {
            const url = document.getElementById('supabase-url').value.trim();
            const keyInput = document.getElementById('supabase-key');
            
            // Gestione speciale per campo password "nascosto"
            let key = keyInput.value;
            if (key === '••••••••••••••••') {
                // Usa la chiave salvata
                key = getSupabaseKey();
                if (!key) {
                    mostraMessaggio('Inserisci la chiave Supabase', 'error');
                    return;
                }
            } else {
                key = key.trim();
            }
            
            // Validazione input
            if (!url || !key) {
                mostraMessaggio('Inserisci URL e Anon Key', 'error');
                return;
            }
            
            if (!url.startsWith('https://')) {
                mostraMessaggio('URL deve iniziare con https://', 'error');
                return;
            }
            
            // Aggiorna UI pulsante
            const btnTest = document.getElementById('btn-test');
            const iconTest = document.getElementById('icon-test');
            const textTest = document.getElementById('text-test');
            
            btnTest.disabled = true;
            btnTest.style.opacity = '0.7';
            iconTest.textContent = 'sync';
            iconTest.style.animation = 'spin 1s linear infinite';
            textTest.textContent = 'Connessione...';
            
            try {
                // SALVA CONFIGURAZIONE PRIMA DEL TEST
                saveDbConfig(url, key);
                
                // TEST CONNESIONE
                const testResult = await testDbConnection();
                
                if (testResult.success) {
                    // Successo
                    mostraMessaggio(`✅ ${testResult.message}`, 'success');
                    
                    // Aggiorna info
                    mostraInfoConfigurazione();
                    loadProfileInfoMobile();
                    
                } else {
                    throw new Error(testResult.error || 'Connessione fallita');
                }
                
            } catch (error) {
                console.error('Errore connessione:', error);
                
                let messaggio = 'Errore di connessione';
                if (error.message.includes('JWT') || error.message.includes('token')) {
                    messaggio = 'Anon Key non valida o scaduta';
                } else if (error.message.includes('fetch') || error.message.includes('network')) {
                    messaggio = 'URL non raggiungibile o errato';
                } else if (error.code === '42501') {
                    messaggio = 'Permessi insufficienti';
                } else {
                    messaggio = error.message.substring(0, 100);
                }
                
                mostraMessaggio(`❌ ${messaggio}`, 'error');
                
            } finally {
                btnTest.disabled = false;
                btnTest.style.opacity = '1';
                iconTest.textContent = 'wifi';
                iconTest.style.animation = 'none';
                textTest.textContent = 'Test Connessione';
            }
        }

        // FUNZIONE: Esporta configurazione corrente
        function esportaConfigurazione() {
            if (!hasDbConfig()) {
                mostraMessaggio('Configura prima URL e Key', 'error');
                return;
            }
            
            try {
                const contenuto = exportDbConfig();
                
                // Crea blob e scarica
                const blob = new Blob([contenuto], { type: 'text/plain' });
                const urlBlob = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlBlob;
                a.download = 'ParkApp_DB_Config.kf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(urlBlob);
                
                mostraMessaggio('✅ Configurazione esportata come ParkApp_DB_Config.kf', 'success');
                
            } catch (error) {
                mostraMessaggio(`Errore esportazione: ${error.message}`, 'error');
            }
        }

        // FUNZIONE: Reset configurazione DB
        function resetConfigurazione() {
            if (!confirm('Sei sicuro di voler resettare la configurazione del database?\nTutti i dati di connessione verranno cancellati.')) {
                return;
            }
            
            try {
                // Cancella solo i dati di configurazione DB dal localStorage
                localStorage.removeItem('flox_db_url');
                localStorage.removeItem('flox_db_key');
                localStorage.removeItem('flox_db_timestamp');
                
                // Resetta variabili
                supabaseClient = null;
                fileCaricato = null;
                
                // Aggiorna UI
                mostraMessaggio('✅ Configurazione database resettata', 'success');
                
                // Aggiorna info
                mostraInfoConfigurazione();
                loadProfileInfoMobile();
                
                // Resetta campi input
                const urlInput = document.getElementById('supabase-url');
                const keyInput = document.getElementById('supabase-key');
                
                if (urlInput) urlInput.value = '';
                if (keyInput) {
                    keyInput.value = '';
                    keyInput.type = 'password';
                    const toggleIcon = document.getElementById('toggle-key-icon');
                    if (toggleIcon) {
                        toggleIcon.textContent = 'visibility';
                    }
                }
                
                // Rimuovi file se presente
                rimuoviFile();
                
            } catch (error) {
                mostraMessaggio(`Errore reset: ${error.message}`, 'error');
            }
        }

        // FUNZIONE: Mostra messaggi (versione mobile)
        function mostraMessaggio(testo, tipo = 'info') {
            const messaggioDiv = document.getElementById('messaggio-stato-mobile');
            if (!messaggioDiv) return;
            
            messaggioDiv.textContent = testo;
            messaggioDiv.className = 'message-mobile';
            
            switch(tipo) {
                case 'success':
                    messaggioDiv.classList.add('message-success');
                    break;
                case 'error':
                    messaggioDiv.classList.add('message-error');
                    break;
                default:
                    messaggioDiv.classList.add('message-info');
            }
            
            messaggioDiv.style.display = 'block';
            
            setTimeout(() => {
                messaggioDiv.style.display = 'none';
            }, 5000);
        }

        // Inizializza la pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Aggiorna indicatore DB
            const dbInfo = getDbConfigInfo();
            const indicator = document.getElementById('db-status-indicator');
            
            if (dbInfo.configured) {
                indicator.style.background = '#22c55e';
                indicator.title = `DB configurato • ${dbInfo.urlShort || 'N/A'}`;
            } else {
                indicator.style.background = '#f59e0b';
                indicator.title = 'Database non configurato';
            }
            
            // Carica profilo iniziale
            loadProfileInfoMobile();
        });
    </script>
</body>
</html>
